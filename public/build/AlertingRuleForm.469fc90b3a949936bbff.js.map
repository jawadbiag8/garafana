{"version":3,"sources":["webpack:///./public/app/features/alerting/unified/components/rule-editor/RuleEditorSection.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/SelectWIthAdd.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/GroupAndNamespaceFields.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/AlertTypeStep.tsx","webpack:///./public/app/features/alerting/unified/hooks/useRuleSourcesWithRuler.ts","webpack:///./public/app/features/alerting/unified/components/rule-editor/LabelsField.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/AnnotationKeyInput.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/AnnotationsField.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/DetailsStep.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/ExpressionEditor.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/VizWrapper.tsx","webpack:///./public/app/features/alerting/unified/hooks/useVizHeight.ts","webpack:///./public/app/features/expressions/guards.ts","webpack:///./public/app/features/alerting/unified/components/rule-editor/QueryWrapper.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/QueryRows.tsx","webpack:///./public/app/features/alerting/unified/utils/timeRange.ts","webpack:///./public/app/features/alerting/unified/state/AlertingQueryRunner.ts","webpack:///./public/app/features/alerting/unified/components/rule-editor/QueryEditor.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/QueryStep.tsx","webpack:///./public/app/features/alerting/unified/api/preview.ts","webpack:///./public/app/features/alerting/unified/types/preview.ts","webpack:///./public/app/features/alerting/unified/components/rule-editor/PreviewRuleResult.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/PreviewRule.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/CloudConditionsStep.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/ConditionField.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/GrafanaAlertStatePicker.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/GrafanaConditionEvalWarning.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/GrafanaConditionsStep.tsx","webpack:///./public/app/features/alerting/unified/components/rule-editor/AlertRuleForm.tsx","webpack:///./public/app/features/alerting/unified/RuleEditor.tsx","webpack:///./public/app/core/hooks/useQueryParams.ts","webpack:///./public/app/features/alerting/unified/hooks/useFolder.ts","webpack:///./public/app/features/alerting/unified/hooks/useIsRuleEditable.ts","webpack:///./public/app/core/hooks/useCleanup.ts","webpack:///./node_modules/timers-browserify/main.js","webpack:///./node_modules/setimmediate/setImmediate.js"],"names":["RuleEditorSection","title","stepNo","children","description","styles","useStyles2","getStyles","className","parent","content","label","fieldset","theme","css","spacing","breakpoints","values","xl","colors","text","maxContrast","background","canvas","typography","size","lg","SelectWithAdd","value","onChange","options","placeholder","width","custom","onCustomChange","disabled","addLabel","isCustom","setIsCustom","useState","useEffect","_options","useMemo","autoFocus","e","target","val","GroupAndNamespaceFields","dataSourceName","control","watch","formState","errors","setValue","useFormContext","style","getStyle","customGroup","setCustomGroup","rulerRequests","useUnifiedAlertingSelector","state","rulerRules","dispatch","useDispatch","fetchRulerRulesAction","rulesConfig","result","namespace","namespaceOptions","Object","keys","map","groupOptions","group","name","flexRow","error","message","invalid","render","field","input","rules","required","alertTypeOptions","RuleFormType","grafana","contextSrv","isEditor","push","cloud","AlertTypeStep","editingExistingRule","register","ruleFormType","rulesSourcesWithRuler","getAllDataSources","filter","ds","type","DataSourceType","Prometheus","forEach","fetchRulerRulesIfNotFetchedYet","getRulesDataSources","Loki","useRulesSourcesWithRuler","dataSourceFilter","useCallback","meta","alerting","find","id","formInput","v","current","noDefault","undefined","folder","RuleFolderPicker","enableCreateNew","enableReset","wrapper","md","flexColumn","xs","deleteLabelButton","addLabelButton","centerAlignRow","equalSign","labelInput","sm","LabelsField","useStyles","labels","cx","fields","append","remove","index","key","defaultValue","aria-label","icon","variant","onClick","AnnotationKeyInput","existingKeys","rest","annotationOptions","Annotation","includes","annotationLabels","annotationValueInput","textarea","addAnnotationsButton","flexRowItemMargin","AnnotationsField","annotations","_","idx","isUrl","toLocaleLowerCase","endsWith","ValueInputComponent","Input","TextArea","DetailsStep","ExpressionEditor","mapToValue","mapToQuery","settings","getDataSourceSrv","getInstanceSettings","query","expr","existing","Error","useQueryMappers","setQuery","refId","hide","loading","dataSource","useAsync","get","onChangeQuery","components","QueryEditor","errorMessage","queries","app","CoreApp","CloudAlerting","onRunQuery","noop","datasource","VizWrapper","data","currentPanel","changePanel","setOptions","frameIndex","showHeader","panels","getSupportedPanels","vizHeight","pluginId","useTheme2","TIMESERIES","STAT","series","dataIsEmpty","length","rowHeight","gridSize","tableHeight","useVizHeight","buttonGroup","height","onOptionsChange","config","p","TABLE","panel","imgUrl","info","logos","small","visHeight","autoSizerWrapper","isExpressionQuery","dataQuery","ExpressionDatasourceID","expression","ExpressionQueryType","QueryWrapper","dsSettings","onChangeDataSource","onChangeTimeRange","onRunQueries","onRemoveQuery","onDuplicateQuery","isExpression","model","changePluginId","QueryEditorRow","cloneDeep","onAddQuery","renderHeaderExtras","timeRange","relativeTimeRange","getDefaultRelativeTimeRange","range","renderTimePicker","visualization","hideDisableQuery","border","medium","shape","borderRadius","QueryRows","PureComponent","constructor","props","super","this","onQueriesChange","item","itemIndex","previous","datasourceUid","uid","onDragEnd","destination","startIndex","source","endIndex","update","Array","from","removed","splice","getDataSourceSettings","dataPerQuery","droppableId","direction","provided","ref","innerRef","droppableProps","FALL_BACK_TIME_RANGE","to","getReferencedIds","classic","getReferencedIdsForClassicCondition","math","getReferencedIdsForMath","resample","reduce","getReferencedIdsForReduce","conditions","condition","params","getTimeRanges","referencedRefIds","referencedRefIdsKey","q","queryType","AlertingQueryRunner","backendSrv","getBackendSrv","subject","subscription","lastResult","ReplaySubject","asObservable","run","empty","initialState","LoadingState","Done","next","runRequest","subscribe","nextResult","applyChange","preProcessed","preProcessPanelData","setStructureRevision","mapErrorToPanelData","cancel","unsubscribe","requestIsRunning","Loading","destroy","complete","initial","request","url","method","requestId","uuidv4","withLoadingIndicator","whileLoading","fetch","pipe","mapToPanelData","catchError","of","cancelNetworkRequestsOnUnsubscribe","share","dataByQuery","getTimeRange","relative","Math","max","min","getTimeRangeForExpression","rangeUtil","relativeToTimeRange","console","warn","getDefaultTimeRange","response","results","entries","frames","dataFrameFromJSON","queryError","toDataQueryError","change","runner","onCancelQueries","onChangeQueries","addQuery","onNewAlertingQuery","defaultDataSource","getDatasourceSrv","onNewExpressionQuery","ExpressionDatasourceUID","expressionDatasource","newQuery","defaultCondition","panelDataByRefId","componentDidMount","setState","componentWillUnmount","renderAddQueryRow","align","selectors","QueryTab","expressionsEnabled","placement","expressionButton","isRunning","d","Boolean","renderRunQueryButton","theme2","runWrapper","container","queryToAdd","getNextRefIdChar","defaultTimeRange","stylesFactory","primary","xxl","editorWrapper","QueryStep","validate","isArray","previewAlertRule","isCloudPreviewRequest","previewCloudAlertRule","isGrafanaPreviewRequest","createResponse","instances","previewGrafanaAlertRule","ruleType","PreviewRuleResult","preview","table","PreviewRule","onPreview","setPreview","getValues","isMounted","useMountedState","grafana_condition","now","dateTimeFormatISO","Date","createPreviewRequest","takeWhile","isCompleted","usePreview","CloudConditionsStep","forTime","inlineField","pattern","timeOptions","timeUnit","ConditionField","expressions","noOptionsMessage","GrafanaAlertStateDecision","Alerting","NoData","OK","GrafanaAlertStatePicker","includeNoData","opts","opt","GrafanaConditionEvalWarning","evaluateFor","evaluateEvery","durationFor","parseDuration","durationEvery","isEmpty","millisFor","durationToMilliseconds","millisEvery","severity","forValidationOptions","durationValidationPattern","evaluateEveryValidationOptions","positiveDurationValidationPattern","duration","diff","MIN_TIME_RANGE_STEP_S","GrafanaConditionsStep","showErrorHandling","setShowErrorHandling","tooltip","validationMessageHorizontalOverflow","horizontal","switchField","AlertRuleForm","queryParams","useQueryParams","returnTo","defaultValues","rulerRuleToFormValues","getDefaultFormValues","getDefaultQueries","JSON","parse","formAPI","useForm","mode","shouldFocusError","handleSubmit","showStep2","submitState","ruleForm","saveRule","initialAsyncRequestState","useCleanup","unifiedAlerting","submit","exitOnSave","saveRuleFormAction","trim","redirectOnSave","onInvalid","appEvents","emit","AppEvents","alertError","onSubmit","preventDefault","form","pageIcon","fill","buttonSpinner","inline","contentOuter","autoHeightMin","hideHorizontalTrack","contentInner","weak","ExistingRuleEditor","identifier","existingRule","dispatched","isEditable","useIsRuleEditable","rule","fetchExistingRuleAction","Page","Contents","AlertWarning","warningStyles","warning","href","withErrorBoundary","match","parseRuleIdentifier","decodeURIComponent","hasEditPermissionInFolders","search","useLocation","locationSearchToObject","replace","setImmediate","locationService","partial","useFolder","folderRequests","folders","fetchFolderIfNotFetchedAction","folderUID","isGrafanaRulerRule","grafana_alert","namespace_uid","canSave","stateSelector","selectorRef","useRef","cleanUpAction","self","window","apply","Function","prototype","Timeout","clearFn","_id","_clearFn","exports","setTimeout","call","scope","arguments","clearTimeout","setInterval","clearInterval","timeout","close","unref","enroll","msecs","_idleTimeoutId","_idleTimeout","unenroll","_unrefActive","active","_onTimeout","global","clearImmediate","registerImmediate","html","channel","messagePrefix","onGlobalMessage","nextHandle","tasksByHandle","currentlyRunningATask","doc","document","attachTo","getPrototypeOf","toString","process","handle","nextTick","runIfPresent","postMessage","importScripts","postMessageIsAsynchronous","oldOnMessage","onmessage","canUsePostMessage","MessageChannel","port1","event","port2","createElement","documentElement","script","onreadystatechange","removeChild","appendChild","random","indexOf","slice","addEventListener","attachEvent","callback","args","i","task"],"mappings":"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","file":"AlertingRuleForm.469fc90b3a949936bbff.js","sourcesContent":["import { css } from '@emotion/css';\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { FieldSet, useStyles2 } from '@grafana/ui';\nimport React, { FC } from 'react';\n\nexport interface RuleEditorSectionProps {\n  title: string;\n  stepNo: number;\n  description?: string;\n}\n\nexport const RuleEditorSection: FC<RuleEditorSectionProps> = ({ title, stepNo, children, description }) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <div className={styles.parent}>\n      <div>\n        <span className={styles.stepNo}>{stepNo}</span>\n      </div>\n      <div className={styles.content}>\n        <FieldSet label={title} className={styles.fieldset}>\n          {description && <p className={styles.description}>{description}</p>}\n          {children}\n        </FieldSet>\n      </div>\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  fieldset: css`\n    legend {\n      font-size: 16px;\n      padding-top: ${theme.spacing(0.5)};\n    }\n  `,\n  parent: css`\n    display: flex;\n    flex-direction: row;\n    max-width: ${theme.breakpoints.values.xl};\n    & + & {\n      margin-top: ${theme.spacing(4)};\n    }\n  `,\n  description: css`\n    margin-top: -${theme.spacing(2)};\n  `,\n  stepNo: css`\n    display: inline-block;\n    width: ${theme.spacing(4)};\n    height: ${theme.spacing(4)};\n    line-height: ${theme.spacing(4)};\n    border-radius: ${theme.spacing(4)};\n    text-align: center;\n    color: ${theme.colors.text.maxContrast};\n    background-color: ${theme.colors.background.canvas};\n    font-size: ${theme.typography.size.lg};\n    margin-right: ${theme.spacing(2)};\n  `,\n  content: css`\n    flex: 1;\n  `,\n});\n","import { SelectableValue } from '@grafana/data';\nimport { Input, Select } from '@grafana/ui';\nimport React, { FC, useEffect, useMemo, useState } from 'react';\n\ninterface Props {\n  onChange: (value: string) => void;\n  options: Array<SelectableValue<string>>;\n  value?: string;\n  addLabel?: string;\n  className?: string;\n  placeholder?: string;\n  custom?: boolean;\n  onCustomChange?: (custom: boolean) => void;\n  width?: number;\n  disabled?: boolean;\n}\n\nexport const SelectWithAdd: FC<Props> = ({\n  value,\n  onChange,\n  options,\n  className,\n  placeholder,\n  width,\n  custom,\n  onCustomChange,\n  disabled = false,\n  addLabel = '+ Add new',\n}) => {\n  const [isCustom, setIsCustom] = useState(custom);\n\n  useEffect(() => {\n    if (custom) {\n      setIsCustom(custom);\n    }\n  }, [custom]);\n\n  const _options = useMemo((): Array<SelectableValue<string>> => [...options, { value: '__add__', label: addLabel }], [\n    options,\n    addLabel,\n  ]);\n\n  if (isCustom) {\n    return (\n      <Input\n        width={width}\n        autoFocus={!custom}\n        value={value || ''}\n        placeholder={placeholder}\n        className={className}\n        disabled={disabled}\n        onChange={(e) => onChange((e.target as HTMLInputElement).value)}\n      />\n    );\n  } else {\n    return (\n      <Select\n        width={width}\n        options={_options}\n        value={value}\n        className={className}\n        placeholder={placeholder}\n        disabled={disabled}\n        onChange={(val: SelectableValue) => {\n          const value = val?.value;\n          if (value === '__add__') {\n            setIsCustom(true);\n            if (onCustomChange) {\n              onCustomChange(true);\n            }\n            onChange('');\n          } else {\n            onChange(value);\n          }\n        }}\n      />\n    );\n  }\n};\n","import React, { FC, useEffect, useMemo, useState } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { useUnifiedAlertingSelector } from '../../hooks/useUnifiedAlertingSelector';\nimport { fetchRulerRulesAction } from '../../state/actions';\nimport { RuleFormValues } from '../../types/rule-form';\nimport { useFormContext } from 'react-hook-form';\nimport { GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { SelectWithAdd } from './SelectWIthAdd';\nimport { Field, InputControl, useStyles2 } from '@grafana/ui';\nimport { css } from '@emotion/css';\n\ninterface Props {\n  dataSourceName: string;\n}\n\nexport const GroupAndNamespaceFields: FC<Props> = ({ dataSourceName }) => {\n  const {\n    control,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues>();\n\n  const style = useStyles2(getStyle);\n\n  const [customGroup, setCustomGroup] = useState(false);\n\n  const rulerRequests = useUnifiedAlertingSelector((state) => state.rulerRules);\n  const dispatch = useDispatch();\n  useEffect(() => {\n    dispatch(fetchRulerRulesAction(dataSourceName));\n  }, [dataSourceName, dispatch]);\n\n  const rulesConfig = rulerRequests[dataSourceName]?.result;\n\n  const namespace = watch('namespace');\n\n  const namespaceOptions = useMemo(\n    (): Array<SelectableValue<string>> =>\n      rulesConfig ? Object.keys(rulesConfig).map((namespace) => ({ label: namespace, value: namespace })) : [],\n    [rulesConfig]\n  );\n\n  const groupOptions = useMemo(\n    (): Array<SelectableValue<string>> =>\n      (namespace && rulesConfig?.[namespace]?.map((group) => ({ label: group.name, value: group.name }))) || [],\n    [namespace, rulesConfig]\n  );\n\n  return (\n    <div className={style.flexRow}>\n      <Field label=\"Namespace\" error={errors.namespace?.message} invalid={!!errors.namespace?.message}>\n        <InputControl\n          render={({ field: { onChange, ref, ...field } }) => (\n            <SelectWithAdd\n              {...field}\n              className={style.input}\n              onChange={(value) => {\n                setValue('group', ''); //reset if namespace changes\n                onChange(value);\n              }}\n              onCustomChange={(custom: boolean) => {\n                custom && setCustomGroup(true);\n              }}\n              options={namespaceOptions}\n              width={42}\n            />\n          )}\n          name=\"namespace\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n          }}\n        />\n      </Field>\n      <Field label=\"Group\" error={errors.group?.message} invalid={!!errors.group?.message}>\n        <InputControl\n          render={({ field: { ref, ...field } }) => (\n            <SelectWithAdd {...field} options={groupOptions} width={42} custom={customGroup} className={style.input} />\n          )}\n          name=\"group\"\n          control={control}\n          rules={{\n            required: { value: true, message: 'Required.' },\n          }}\n        />\n      </Field>\n    </div>\n  );\n};\n\nconst getStyle = (theme: GrafanaTheme2) => ({\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n\n    & > * + * {\n      margin-left: ${theme.spacing(3)};\n    }\n  `,\n  input: css`\n    width: 330px !important;\n  `,\n});\n","import React, { FC, useCallback, useEffect } from 'react';\nimport { DataSourceInstanceSettings, GrafanaTheme2, SelectableValue } from '@grafana/data';\nimport { Field, Input, InputControl, Select, useStyles2 } from '@grafana/ui';\nimport { css } from '@emotion/css';\n\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { useFormContext } from 'react-hook-form';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { useRulesSourcesWithRuler } from '../../hooks/useRuleSourcesWithRuler';\nimport { RuleFolderPicker } from './RuleFolderPicker';\nimport { GroupAndNamespaceFields } from './GroupAndNamespaceFields';\nimport { contextSrv } from 'app/core/services/context_srv';\n\nconst alertTypeOptions: SelectableValue[] = [\n  {\n    label: 'Grafana managed alert',\n    value: RuleFormType.grafana,\n    description: 'Classic Grafana alerts based on thresholds.',\n  },\n];\n\nif (contextSrv.isEditor) {\n  alertTypeOptions.push({\n    label: 'Cortex/Loki managed alert',\n    value: RuleFormType.cloud,\n    description: 'Alert based on a system or application behavior. Based on Prometheus.',\n  });\n}\n\ninterface Props {\n  editingExistingRule: boolean;\n}\n\nexport const AlertTypeStep: FC<Props> = ({ editingExistingRule }) => {\n  const styles = useStyles2(getStyles);\n\n  const {\n    register,\n    control,\n    watch,\n    formState: { errors },\n    setValue,\n  } = useFormContext<RuleFormValues & { location?: string }>();\n\n  const ruleFormType = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  useEffect(() => {}, [ruleFormType]);\n\n  const rulesSourcesWithRuler = useRulesSourcesWithRuler();\n\n  const dataSourceFilter = useCallback(\n    (ds: DataSourceInstanceSettings): boolean => {\n      if (ruleFormType === RuleFormType.grafana) {\n        return !!ds.meta.alerting;\n      } else {\n        // filter out only rules sources that support ruler and thus can have alerts edited\n        return !!rulesSourcesWithRuler.find(({ id }) => id === ds.id);\n      }\n    },\n    [ruleFormType, rulesSourcesWithRuler]\n  );\n\n  return (\n    <RuleEditorSection stepNo={1} title=\"Alert type\">\n      <Field\n        className={styles.formInput}\n        label=\"Alert name\"\n        error={errors?.name?.message}\n        invalid={!!errors.name?.message}\n      >\n        <Input\n          {...register('name', { required: { value: true, message: 'Must enter an alert name' } })}\n          autoFocus={true}\n        />\n      </Field>\n      <div className={styles.flexRow}>\n        <Field\n          disabled={editingExistingRule}\n          label=\"Alert type\"\n          className={styles.formInput}\n          error={errors.type?.message}\n          invalid={!!errors.type?.message}\n        >\n          <InputControl\n            render={({ field: { onChange, ref, ...field } }) => (\n              <Select\n                {...field}\n                options={alertTypeOptions}\n                onChange={(v: SelectableValue) => {\n                  const value = v?.value;\n                  // when switching to system alerts, null out data source selection if it's not a rules source with ruler\n                  if (\n                    value === RuleFormType.cloud &&\n                    dataSourceName &&\n                    !rulesSourcesWithRuler.find(({ name }) => name === dataSourceName)\n                  ) {\n                    setValue('dataSourceName', null);\n                  }\n                  onChange(value);\n                }}\n              />\n            )}\n            name=\"type\"\n            control={control}\n            rules={{\n              required: { value: true, message: 'Please select alert type' },\n            }}\n          />\n        </Field>\n        {ruleFormType === RuleFormType.cloud && (\n          <Field\n            className={styles.formInput}\n            label=\"Select data source\"\n            error={errors.dataSourceName?.message}\n            invalid={!!errors.dataSourceName?.message}\n          >\n            <InputControl\n              render={({ field: { onChange, ref, value, ...field } }) => (\n                <DataSourcePicker\n                  {...field}\n                  current={value}\n                  filter={dataSourceFilter}\n                  noDefault\n                  alerting\n                  onChange={(ds: DataSourceInstanceSettings) => {\n                    // reset location if switching data sources, as different rules source will have different groups and namespaces\n                    setValue('location', undefined);\n                    onChange(ds?.name ?? null);\n                  }}\n                />\n              )}\n              name=\"dataSourceName\"\n              control={control}\n              rules={{\n                required: { value: true, message: 'Please select a data source' },\n              }}\n            />\n          </Field>\n        )}\n      </div>\n      {ruleFormType === RuleFormType.cloud && dataSourceName && (\n        <GroupAndNamespaceFields dataSourceName={dataSourceName} />\n      )}\n      {ruleFormType === RuleFormType.grafana && (\n        <Field\n          label=\"Folder\"\n          className={styles.formInput}\n          error={errors.folder?.message}\n          invalid={!!errors.folder?.message}\n        >\n          <InputControl\n            render={({ field: { ref, ...field } }) => (\n              <RuleFolderPicker {...field} enableCreateNew={true} enableReset={true} />\n            )}\n            name=\"folder\"\n            rules={{\n              required: { value: true, message: 'Please select a folder' },\n            }}\n          />\n        </Field>\n      )}\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  formInput: css`\n    width: 330px;\n    & + & {\n      margin-left: ${theme.spacing(3)};\n    }\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n  `,\n});\n","import { DataSourceInstanceSettings } from '@grafana/data';\nimport { useEffect, useMemo } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { fetchRulerRulesIfNotFetchedYet } from '../state/actions';\nimport { getAllDataSources } from '../utils/config';\nimport { DataSourceType, getRulesDataSources } from '../utils/datasource';\nimport { useUnifiedAlertingSelector } from './useUnifiedAlertingSelector';\n\nexport function useRulesSourcesWithRuler(): DataSourceInstanceSettings[] {\n  const rulerRequests = useUnifiedAlertingSelector((state) => state.rulerRules);\n  const dispatch = useDispatch();\n\n  // try fetching rules for each prometheus to see if it has ruler\n  useEffect(() => {\n    getAllDataSources()\n      .filter((ds) => ds.type === DataSourceType.Prometheus)\n      .forEach((ds) => dispatch(fetchRulerRulesIfNotFetchedYet(ds.name)));\n  }, [dispatch]);\n\n  return useMemo(\n    () => getRulesDataSources().filter((ds) => ds.type === DataSourceType.Loki || !!rulerRequests[ds.name]?.result),\n    [rulerRequests]\n  );\n}\n","import React, { FC } from 'react';\nimport { Button, Field, FieldArray, Input, InlineLabel, Label, useStyles } from '@grafana/ui';\nimport { GrafanaTheme } from '@grafana/data';\nimport { css, cx } from '@emotion/css';\nimport { useFormContext } from 'react-hook-form';\n\ninterface Props {\n  className?: string;\n}\n\nconst LabelsField: FC<Props> = ({ className }) => {\n  const styles = useStyles(getStyles);\n  const {\n    register,\n    control,\n    watch,\n    formState: { errors },\n  } = useFormContext();\n  const labels = watch('labels');\n  return (\n    <div className={cx(className, styles.wrapper)}>\n      <Label>Custom Labels</Label>\n      <FieldArray control={control} name=\"labels\">\n        {({ fields, append, remove }) => {\n          return (\n            <>\n              <div className={styles.flexRow}>\n                <InlineLabel width={18}>Labels</InlineLabel>\n                <div className={styles.flexColumn}>\n                  {fields.map((field, index) => {\n                    return (\n                      <div key={field.id}>\n                        <div className={cx(styles.flexRow, styles.centerAlignRow)}>\n                          <Field\n                            className={styles.labelInput}\n                            invalid={!!errors.labels?.[index]?.key?.message}\n                            error={errors.labels?.[index]?.key?.message}\n                          >\n                            <Input\n                              {...register(`labels[${index}].key`, {\n                                required: { value: !!labels[index]?.value, message: 'Required.' },\n                              })}\n                              placeholder=\"key\"\n                              defaultValue={field.key}\n                            />\n                          </Field>\n                          <InlineLabel className={styles.equalSign}>=</InlineLabel>\n                          <Field\n                            className={styles.labelInput}\n                            invalid={!!errors.labels?.[index]?.value?.message}\n                            error={errors.labels?.[index]?.value?.message}\n                          >\n                            <Input\n                              {...register(`labels[${index}].value`, {\n                                required: { value: !!labels[index]?.key, message: 'Required.' },\n                              })}\n                              placeholder=\"value\"\n                              defaultValue={field.value}\n                            />\n                          </Field>\n                          <Button\n                            className={styles.deleteLabelButton}\n                            aria-label=\"delete label\"\n                            icon=\"trash-alt\"\n                            variant=\"secondary\"\n                            onClick={() => {\n                              remove(index);\n                            }}\n                          />\n                        </div>\n                      </div>\n                    );\n                  })}\n                  <Button\n                    className={styles.addLabelButton}\n                    icon=\"plus-circle\"\n                    type=\"button\"\n                    variant=\"secondary\"\n                    onClick={() => {\n                      append({});\n                    }}\n                  >\n                    Add label\n                  </Button>\n                </div>\n              </div>\n            </>\n          );\n        }}\n      </FieldArray>\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme) => {\n  return {\n    wrapper: css`\n      margin-top: ${theme.spacing.md};\n    `,\n    flexColumn: css`\n      display: flex;\n      flex-direction: column;\n    `,\n    flexRow: css`\n      display: flex;\n      flex-direction: row;\n      justify-content: flex-start;\n\n      & + button {\n        margin-left: ${theme.spacing.xs};\n      }\n    `,\n    deleteLabelButton: css`\n      margin-left: ${theme.spacing.xs};\n      align-self: flex-start;\n    `,\n    addLabelButton: css`\n      flex-grow: 0;\n      align-self: flex-start;\n    `,\n    centerAlignRow: css`\n      align-items: baseline;\n    `,\n    equalSign: css`\n      align-self: flex-start;\n      width: 28px;\n      justify-content: center;\n      margin-left: ${theme.spacing.xs};\n    `,\n    labelInput: css`\n      width: 183px;\n      margin-bottom: ${theme.spacing.sm};\n      & + & {\n        margin-left: ${theme.spacing.sm};\n      }\n    `,\n  };\n};\n\nexport default LabelsField;\n","import { SelectableValue } from '@grafana/data';\nimport React, { FC, useMemo } from 'react';\nimport { SelectWithAdd } from './SelectWIthAdd';\nimport { Annotation, annotationLabels } from '../../utils/constants';\n\ninterface Props {\n  onChange: (value: string) => void;\n  existingKeys: string[];\n\n  value?: string;\n  width?: number;\n  className?: string;\n}\n\nexport const AnnotationKeyInput: FC<Props> = ({ value, existingKeys, ...rest }) => {\n  const annotationOptions = useMemo(\n    (): SelectableValue[] =>\n      Object.values(Annotation)\n        .filter((key) => !existingKeys.includes(key)) // remove keys already taken in other annotations\n        .map((key) => ({ value: key, label: annotationLabels[key] })),\n    [existingKeys]\n  );\n\n  return (\n    <SelectWithAdd\n      value={value}\n      options={annotationOptions}\n      custom={!!value && !(Object.values(Annotation) as string[]).includes(value)}\n      {...rest}\n    />\n  );\n};\n","import React, { FC, useCallback } from 'react';\nimport { Button, Field, FieldArray, Input, InputControl, Label, TextArea, useStyles } from '@grafana/ui';\nimport { GrafanaTheme } from '@grafana/data';\nimport { css, cx } from '@emotion/css';\nimport { useFormContext } from 'react-hook-form';\nimport { RuleFormValues } from '../../types/rule-form';\nimport { AnnotationKeyInput } from './AnnotationKeyInput';\n\nconst AnnotationsField: FC = () => {\n  const styles = useStyles(getStyles);\n  const {\n    control,\n    register,\n    watch,\n    formState: { errors },\n  } = useFormContext();\n  const annotations = watch('annotations') as RuleFormValues['annotations'];\n\n  const existingKeys = useCallback(\n    (index: number): string[] => annotations.filter((_, idx: number) => idx !== index).map(({ key }) => key),\n    [annotations]\n  );\n\n  return (\n    <>\n      <Label>Summary and annotations</Label>\n      <FieldArray name={'annotations'} control={control}>\n        {({ fields, append, remove }) => {\n          return (\n            <div className={styles.flexColumn}>\n              {fields.map((field, index) => {\n                const isUrl = annotations[index]?.key?.toLocaleLowerCase().endsWith('url');\n                const ValueInputComponent = isUrl ? Input : TextArea;\n                return (\n                  <div key={field.id} className={styles.flexRow}>\n                    <Field\n                      className={styles.field}\n                      invalid={!!errors.annotations?.[index]?.key?.message}\n                      error={errors.annotations?.[index]?.key?.message}\n                    >\n                      <InputControl\n                        name={`annotations[${index}].key`}\n                        render={({ field: { ref, ...field } }) => (\n                          <AnnotationKeyInput {...field} existingKeys={existingKeys(index)} width={18} />\n                        )}\n                        control={control}\n                        rules={{ required: { value: !!annotations[index]?.value, message: 'Required.' } }}\n                      />\n                    </Field>\n                    <Field\n                      className={cx(styles.flexRowItemMargin, styles.field)}\n                      invalid={!!errors.annotations?.[index]?.value?.message}\n                      error={errors.annotations?.[index]?.value?.message}\n                    >\n                      <ValueInputComponent\n                        className={cx(styles.annotationValueInput, { [styles.textarea]: !isUrl })}\n                        {...register(`annotations[${index}].value`)}\n                        placeholder={isUrl ? 'https://' : `Text`}\n                        defaultValue={field.value}\n                      />\n                    </Field>\n                    <Button\n                      type=\"button\"\n                      className={styles.flexRowItemMargin}\n                      aria-label=\"delete annotation\"\n                      icon=\"trash-alt\"\n                      variant=\"secondary\"\n                      onClick={() => remove(index)}\n                    />\n                  </div>\n                );\n              })}\n              <Button\n                className={styles.addAnnotationsButton}\n                icon=\"plus-circle\"\n                type=\"button\"\n                variant=\"secondary\"\n                onClick={() => {\n                  append({ key: '', value: '' });\n                }}\n              >\n                Add info\n              </Button>\n            </div>\n          );\n        }}\n      </FieldArray>\n    </>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  annotationValueInput: css`\n    width: 426px;\n  `,\n  textarea: css`\n    height: 76px;\n  `,\n  addAnnotationsButton: css`\n    flex-grow: 0;\n    align-self: flex-start;\n    margin-left: 148px;\n  `,\n  flexColumn: css`\n    display: flex;\n    flex-direction: column;\n  `,\n  field: css`\n    margin-bottom: ${theme.spacing.xs};\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n  `,\n  flexRowItemMargin: css`\n    margin-left: ${theme.spacing.xs};\n  `,\n});\n\nexport default AnnotationsField;\n","import React, { FC } from 'react';\nimport LabelsField from './LabelsField';\nimport AnnotationsField from './AnnotationsField';\nimport { RuleEditorSection } from './RuleEditorSection';\n\nexport const DetailsStep: FC = () => {\n  return (\n    <RuleEditorSection\n      stepNo={4}\n      title=\"Add details for your alert\"\n      description=\"Write a summary and add labels to help you better manage your alerts\"\n    >\n      <AnnotationsField />\n      <LabelsField />\n    </RuleEditorSection>\n  );\n};\n","import React, { FC, useCallback, useMemo, useState } from 'react';\nimport { noop } from 'lodash';\nimport { CoreApp, DataQuery } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { useAsync } from 'react-use';\nimport { PromQuery } from 'app/plugins/datasource/prometheus/types';\nimport { LokiQuery } from 'app/plugins/datasource/loki/types';\n\ninterface Props {\n  value?: string;\n  onChange: (value: string) => void;\n  dataSourceName: string; // will be a prometheus or loki datasource\n}\n\nexport const ExpressionEditor: FC<Props> = ({ value, onChange, dataSourceName }) => {\n  const { mapToValue, mapToQuery } = useQueryMappers(dataSourceName);\n  const [query, setQuery] = useState(mapToQuery({ refId: 'A', hide: false }, value));\n  const { error, loading, value: dataSource } = useAsync(() => {\n    return getDataSourceSrv().get(dataSourceName);\n  }, [dataSourceName]);\n\n  const onChangeQuery = useCallback(\n    (query: DataQuery) => {\n      setQuery(query);\n      onChange(mapToValue(query));\n    },\n    [onChange, mapToValue]\n  );\n\n  if (loading || dataSource?.name !== dataSourceName) {\n    return null;\n  }\n\n  if (error || !dataSource || !dataSource?.components?.QueryEditor) {\n    const errorMessage = error?.message || 'Data source plugin does not export any Query Editor component';\n    return <div>Could not load query editor due to: {errorMessage}</div>;\n  }\n\n  const QueryEditor = dataSource?.components?.QueryEditor;\n\n  return (\n    <QueryEditor\n      query={query}\n      queries={[query]}\n      app={CoreApp.CloudAlerting}\n      onChange={onChangeQuery}\n      onRunQuery={noop}\n      datasource={dataSource}\n    />\n  );\n};\n\ntype QueryMappers<T extends DataQuery = DataQuery> = {\n  mapToValue: (query: T) => string;\n  mapToQuery: (existing: T, value: string | undefined) => T;\n};\n\nfunction useQueryMappers(dataSourceName: string): QueryMappers {\n  return useMemo(() => {\n    const settings = getDataSourceSrv().getInstanceSettings(dataSourceName);\n\n    switch (settings?.type) {\n      case 'loki':\n      case 'prometheus':\n        return {\n          mapToValue: (query: PromQuery | LokiQuery) => query.expr,\n          mapToQuery: (existing: DataQuery, value: string | undefined) => ({ ...existing, expr: value }),\n        };\n      default:\n        throw new Error(`${dataSourceName} is not supported as an expression editor`);\n    }\n  }, [dataSourceName]);\n}\n","import React, { FC, useState } from 'react';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { css } from '@emotion/css';\nimport { GrafanaTheme2, PanelData } from '@grafana/data';\nimport { config, PanelRenderer } from '@grafana/runtime';\nimport { RadioButtonGroup, useStyles2 } from '@grafana/ui';\nimport { PanelOptions } from 'app/plugins/panel/table/models.gen';\nimport { SupportedPanelPlugins } from './QueryWrapper';\nimport { useVizHeight } from '../../hooks/useVizHeight';\nimport { STAT, TABLE, TIMESERIES } from '../../utils/constants';\n\ninterface Props {\n  data: PanelData;\n  currentPanel: SupportedPanelPlugins;\n  changePanel: (panel: SupportedPanelPlugins) => void;\n}\n\nexport const VizWrapper: FC<Props> = ({ data, currentPanel, changePanel }) => {\n  const [options, setOptions] = useState<PanelOptions>({\n    frameIndex: 0,\n    showHeader: true,\n  });\n  const panels = getSupportedPanels();\n  const vizHeight = useVizHeight(data, currentPanel, options.frameIndex);\n  const styles = useStyles2(getStyles(vizHeight));\n\n  if (!options || !data) {\n    return null;\n  }\n\n  return (\n    <div className={styles.wrapper}>\n      <div className={styles.buttonGroup}>\n        <RadioButtonGroup options={panels} value={currentPanel} onChange={changePanel} />\n      </div>\n      <AutoSizer>\n        {({ width }) => {\n          if (width === 0) {\n            return null;\n          }\n          return (\n            <div style={{ height: `${vizHeight}px`, width: `${width}px` }}>\n              <PanelRenderer\n                height={vizHeight}\n                width={width}\n                data={data}\n                pluginId={currentPanel}\n                title=\"title\"\n                onOptionsChange={setOptions}\n                options={options}\n              />\n            </div>\n          );\n        }}\n      </AutoSizer>\n    </div>\n  );\n};\n\nconst getSupportedPanels = () => {\n  return Object.values(config.panels)\n    .filter((p) => p.id === TIMESERIES || p.id === TABLE || p.id === STAT)\n    .map((panel) => ({ value: panel.id, label: panel.name, imgUrl: panel.info.logos.small }));\n};\n\nconst getStyles = (visHeight: number) => (theme: GrafanaTheme2) => ({\n  wrapper: css`\n    padding: 0 ${theme.spacing(2)};\n    height: ${visHeight + theme.spacing.gridSize * 4}px;\n  `,\n  autoSizerWrapper: css`\n    width: 100%;\n    height: 200px;\n  `,\n  buttonGroup: css`\n    display: flex;\n    justify-content: flex-end;\n  `,\n});\n","import { PanelData } from '@grafana/data';\nimport { useTheme2 } from '@grafana/ui';\nimport { STAT, TIMESERIES } from '../utils/constants';\n\nexport function useVizHeight(data: PanelData, pluginId: string, frameIndex: number) {\n  const theme = useTheme2();\n  if (pluginId === TIMESERIES || pluginId === STAT || dataIsEmpty(data)) {\n    return 200;\n  }\n\n  const values = data.series[frameIndex].fields[0].values.length;\n  const rowHeight = theme.spacing.gridSize * 5;\n\n  /*\n   Calculate how if we can make  the table smaller than 200px\n   for when we only have 1-2 values\n   The extra rowHeight is to accommodate the header.\n  */\n  const tableHeight = values * rowHeight + rowHeight;\n\n  return tableHeight >= 200 ? 200 : tableHeight;\n}\n\nfunction dataIsEmpty(data: PanelData) {\n  return !data || !data.series[0] || !data.series[0].fields[0] || !data.series[0].fields[0].values;\n}\n","import { DataQuery } from '@grafana/data';\nimport { ExpressionDatasourceID } from './ExpressionDatasource';\nimport { ExpressionQuery, ExpressionQueryType } from './types';\n\nexport const isExpressionQuery = (dataQuery?: DataQuery): dataQuery is ExpressionQuery => {\n  if (!dataQuery) {\n    return false;\n  }\n\n  if (dataQuery.datasource === ExpressionDatasourceID) {\n    return true;\n  }\n\n  const expression = dataQuery as ExpressionQuery;\n\n  if (typeof expression.type !== 'string') {\n    return false;\n  }\n  return Object.values(ExpressionQueryType).includes(expression.type);\n};\n","import React, { FC, ReactNode, useState } from 'react';\nimport { css } from '@emotion/css';\nimport { cloneDeep } from 'lodash';\nimport {\n  DataQuery,\n  DataSourceInstanceSettings,\n  GrafanaTheme2,\n  PanelData,\n  RelativeTimeRange,\n  getDefaultRelativeTimeRange,\n} from '@grafana/data';\nimport { useStyles2, RelativeTimeRangePicker } from '@grafana/ui';\nimport { QueryEditorRow } from 'app/features/query/components/QueryEditorRow';\nimport { VizWrapper } from './VizWrapper';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { TABLE, TIMESERIES } from '../../utils/constants';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\ninterface Props {\n  data: PanelData;\n  query: AlertQuery;\n  queries: AlertQuery[];\n  dsSettings: DataSourceInstanceSettings;\n  onChangeDataSource: (settings: DataSourceInstanceSettings, index: number) => void;\n  onChangeQuery: (query: DataQuery, index: number) => void;\n  onChangeTimeRange?: (timeRange: RelativeTimeRange, index: number) => void;\n  onRemoveQuery: (query: DataQuery) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  onRunQueries: () => void;\n  index: number;\n}\n\nexport type SupportedPanelPlugins = 'timeseries' | 'table' | 'stat';\n\nexport const QueryWrapper: FC<Props> = ({\n  data,\n  dsSettings,\n  index,\n  onChangeDataSource,\n  onChangeQuery,\n  onChangeTimeRange,\n  onRunQueries,\n  onRemoveQuery,\n  onDuplicateQuery,\n  query,\n  queries,\n}) => {\n  const styles = useStyles2(getStyles);\n  const isExpression = isExpressionQuery(query.model);\n  const [pluginId, changePluginId] = useState<SupportedPanelPlugins>(isExpression ? TABLE : TIMESERIES);\n\n  const renderTimePicker = (query: AlertQuery, index: number): ReactNode => {\n    if (isExpressionQuery(query.model) || !onChangeTimeRange) {\n      return null;\n    }\n\n    return (\n      <RelativeTimeRangePicker\n        timeRange={query.relativeTimeRange ?? getDefaultRelativeTimeRange()}\n        onChange={(range) => onChangeTimeRange(range, index)}\n      />\n    );\n  };\n\n  return (\n    <div className={styles.wrapper}>\n      <QueryEditorRow\n        dataSource={dsSettings}\n        onChangeDataSource={!isExpression ? (settings) => onChangeDataSource(settings, index) : undefined}\n        id={query.refId}\n        index={index}\n        key={query.refId}\n        data={data}\n        query={cloneDeep(query.model)}\n        onChange={(query) => onChangeQuery(query, index)}\n        onRemoveQuery={onRemoveQuery}\n        onAddQuery={onDuplicateQuery}\n        onRunQuery={onRunQueries}\n        queries={queries}\n        renderHeaderExtras={() => renderTimePicker(query, index)}\n        visualization={data ? <VizWrapper data={data} changePanel={changePluginId} currentPanel={pluginId} /> : null}\n        hideDisableQuery={true}\n      />\n    </div>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  wrapper: css`\n    label: AlertingQueryWrapper;\n    margin-bottom: ${theme.spacing(1)};\n    border: 1px solid ${theme.colors.border.medium};\n    border-radius: ${theme.shape.borderRadius(1)};\n    padding-bottom: ${theme.spacing(1)};\n  `,\n});\n","import React, { PureComponent } from 'react';\nimport { DragDropContext, Droppable, DropResult } from 'react-beautiful-dnd';\nimport { DataQuery, DataSourceInstanceSettings, PanelData, RelativeTimeRange } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\nimport { QueryWrapper } from './QueryWrapper';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\n\ninterface Props {\n  // The query configuration\n  queries: AlertQuery[];\n  data: Record<string, PanelData>;\n\n  // Query editing\n  onQueriesChange: (queries: AlertQuery[]) => void;\n  onDuplicateQuery: (query: AlertQuery) => void;\n  onRunQueries: () => void;\n}\n\ninterface State {\n  dataPerQuery: Record<string, PanelData>;\n}\n\nexport class QueryRows extends PureComponent<Props, State> {\n  constructor(props: Props) {\n    super(props);\n\n    this.state = { dataPerQuery: {} };\n  }\n\n  onRemoveQuery = (query: DataQuery) => {\n    this.props.onQueriesChange(\n      this.props.queries.filter((item) => {\n        return item.model.refId !== query.refId;\n      })\n    );\n  };\n\n  onChangeTimeRange = (timeRange: RelativeTimeRange, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          relativeTimeRange: timeRange,\n        };\n      })\n    );\n  };\n\n  onChangeDataSource = (settings: DataSourceInstanceSettings, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n\n        const previous = getDataSourceSrv().getInstanceSettings(item.datasourceUid);\n\n        if (previous?.type === settings.uid) {\n          return {\n            ...item,\n            datasourceUid: settings.uid,\n          };\n        }\n\n        const { refId, hide } = item.model;\n\n        return {\n          ...item,\n          datasourceUid: settings.uid,\n          model: { refId, hide },\n        };\n      })\n    );\n  };\n\n  onChangeQuery = (query: DataQuery, index: number) => {\n    const { queries, onQueriesChange } = this.props;\n\n    onQueriesChange(\n      queries.map((item, itemIndex) => {\n        if (itemIndex !== index) {\n          return item;\n        }\n        return {\n          ...item,\n          refId: query.refId,\n          model: {\n            ...item.model,\n            ...query,\n            datasource: query.datasource!,\n          },\n        };\n      })\n    );\n  };\n\n  onDragEnd = (result: DropResult) => {\n    const { queries, onQueriesChange } = this.props;\n\n    if (!result || !result.destination) {\n      return;\n    }\n\n    const startIndex = result.source.index;\n    const endIndex = result.destination.index;\n    if (startIndex === endIndex) {\n      return;\n    }\n\n    const update = Array.from(queries);\n    const [removed] = update.splice(startIndex, 1);\n    update.splice(endIndex, 0, removed);\n    onQueriesChange(update);\n  };\n\n  onDuplicateQuery = (query: DataQuery, source: AlertQuery): void => {\n    this.props.onDuplicateQuery({\n      ...source,\n      model: query,\n    });\n  };\n\n  getDataSourceSettings = (query: AlertQuery): DataSourceInstanceSettings | undefined => {\n    return getDataSourceSrv().getInstanceSettings(query.datasourceUid);\n  };\n\n  render() {\n    const { onDuplicateQuery, onRunQueries, queries } = this.props;\n\n    return (\n      <DragDropContext onDragEnd={this.onDragEnd}>\n        <Droppable droppableId=\"alerting-queries\" direction=\"vertical\">\n          {(provided) => {\n            return (\n              <div ref={provided.innerRef} {...provided.droppableProps}>\n                {queries.map((query, index) => {\n                  const data = this.props.data ? this.props.data[query.refId] : ({} as PanelData);\n                  const dsSettings = this.getDataSourceSettings(query);\n\n                  if (!dsSettings) {\n                    return null;\n                  }\n\n                  return (\n                    <QueryWrapper\n                      index={index}\n                      key={`${query.refId}-${index}`}\n                      dsSettings={dsSettings}\n                      data={data}\n                      query={query}\n                      onChangeQuery={this.onChangeQuery}\n                      onRemoveQuery={this.onRemoveQuery}\n                      queries={queries}\n                      onChangeDataSource={this.onChangeDataSource}\n                      onDuplicateQuery={onDuplicateQuery}\n                      onRunQueries={onRunQueries}\n                      onChangeTimeRange={this.onChangeTimeRange}\n                    />\n                  );\n                })}\n                {provided.placeholder}\n              </div>\n            );\n          }}\n        </Droppable>\n      </DragDropContext>\n    );\n  }\n}\n","import { RelativeTimeRange } from '@grafana/data';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\nimport { ExpressionQuery, ExpressionQueryType } from '../../../expressions/types';\n\nconst FALL_BACK_TIME_RANGE = { from: 21600, to: 0 };\n\nexport const getTimeRangeForExpression = (query: ExpressionQuery, queries: AlertQuery[]): RelativeTimeRange => {\n  const referencedRefIds: string[] | undefined = getReferencedIds(query, queries);\n\n  if (!referencedRefIds) {\n    return FALL_BACK_TIME_RANGE;\n  }\n\n  const { from, to } = getTimeRanges(referencedRefIds, queries);\n\n  if (!from.length && !to.length) {\n    return FALL_BACK_TIME_RANGE;\n  }\n\n  return {\n    from: Math.max(...from),\n    to: Math.min(...to),\n  };\n};\n\nconst getReferencedIds = (model: ExpressionQuery, queries: AlertQuery[]): string[] | undefined => {\n  switch (model.type) {\n    case ExpressionQueryType.classic:\n      return getReferencedIdsForClassicCondition(model);\n    case ExpressionQueryType.math:\n      return getReferencedIdsForMath(model, queries);\n    case ExpressionQueryType.resample:\n    case ExpressionQueryType.reduce:\n      return getReferencedIdsForReduce(model);\n  }\n};\n\nconst getReferencedIdsForClassicCondition = (model: ExpressionQuery) => {\n  return model.conditions?.map((condition) => {\n    return condition.query.params[0];\n  });\n};\n\nconst getTimeRanges = (referencedRefIds: string[], queries: AlertQuery[]) => {\n  let from: number[] = [];\n  let to = [FALL_BACK_TIME_RANGE.to];\n  for (const referencedRefIdsKey of referencedRefIds) {\n    const query = queries.find((query) => query.refId === referencedRefIdsKey);\n\n    if (!query || !query.relativeTimeRange) {\n      continue;\n    }\n    from.push(query.relativeTimeRange.from);\n    to.push(query.relativeTimeRange.to);\n  }\n\n  return {\n    from,\n    to,\n  };\n};\n\nconst getReferencedIdsForMath = (model: ExpressionQuery, queries: AlertQuery[]) => {\n  return (\n    queries\n      // filter queries of type query and filter expression on if it includes any refIds\n      .filter((q) => q.queryType === 'query' && model.expression?.includes(q.refId))\n      .map((q) => {\n        return q.refId;\n      })\n  );\n};\n\nconst getReferencedIdsForReduce = (model: ExpressionQuery) => {\n  return model.expression ? [model.expression] : undefined;\n};\n","import { Observable, of, OperatorFunction, ReplaySubject, Unsubscribable } from 'rxjs';\nimport { catchError, map, share } from 'rxjs/operators';\nimport { v4 as uuidv4 } from 'uuid';\nimport {\n  dataFrameFromJSON,\n  DataFrameJSON,\n  getDefaultTimeRange,\n  LoadingState,\n  PanelData,\n  rangeUtil,\n  TimeRange,\n  withLoadingIndicator,\n} from '@grafana/data';\nimport { FetchResponse, toDataQueryError } from '@grafana/runtime';\nimport { BackendSrv, getBackendSrv } from 'app/core/services/backend_srv';\nimport { preProcessPanelData } from 'app/features/query/state/runRequest';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\nimport { getTimeRangeForExpression } from '../utils/timeRange';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\nimport { setStructureRevision } from 'app/features/query/state/processing/revision';\nimport { cancelNetworkRequestsOnUnsubscribe } from 'app/features/query/state/processing/canceler';\n\nexport interface AlertingQueryResult {\n  frames: DataFrameJSON[];\n}\n\nexport interface AlertingQueryResponse {\n  results: Record<string, AlertingQueryResult>;\n}\nexport class AlertingQueryRunner {\n  private subject: ReplaySubject<Record<string, PanelData>>;\n  private subscription?: Unsubscribable;\n  private lastResult: Record<string, PanelData>;\n\n  constructor(private backendSrv = getBackendSrv()) {\n    this.subject = new ReplaySubject(1);\n    this.lastResult = {};\n  }\n\n  get(): Observable<Record<string, PanelData>> {\n    return this.subject.asObservable();\n  }\n\n  run(queries: AlertQuery[]) {\n    if (queries.length === 0) {\n      const empty = initialState(queries, LoadingState.Done);\n      return this.subject.next(empty);\n    }\n\n    this.subscription = runRequest(this.backendSrv, queries).subscribe({\n      next: (dataPerQuery) => {\n        const nextResult = applyChange(dataPerQuery, (refId, data) => {\n          const previous = this.lastResult[refId];\n          const preProcessed = preProcessPanelData(data, previous);\n          return setStructureRevision(preProcessed, previous);\n        });\n\n        this.lastResult = nextResult;\n        this.subject.next(this.lastResult);\n      },\n\n      error: (error: Error) => {\n        this.lastResult = mapErrorToPanelData(this.lastResult, error);\n        this.subject.next(this.lastResult);\n      },\n    });\n  }\n\n  cancel() {\n    if (!this.subscription) {\n      return;\n    }\n    this.subscription.unsubscribe();\n\n    let requestIsRunning = false;\n\n    const nextResult = applyChange(this.lastResult, (refId, data) => {\n      if (data.state === LoadingState.Loading) {\n        requestIsRunning = true;\n      }\n\n      return {\n        ...data,\n        state: LoadingState.Done,\n      };\n    });\n\n    if (requestIsRunning) {\n      this.subject.next(nextResult);\n    }\n  }\n\n  destroy() {\n    if (this.subject) {\n      this.subject.complete();\n    }\n\n    this.cancel();\n  }\n}\n\nconst runRequest = (backendSrv: BackendSrv, queries: AlertQuery[]): Observable<Record<string, PanelData>> => {\n  const initial = initialState(queries, LoadingState.Loading);\n  const request = {\n    data: { data: queries },\n    url: '/api/v1/eval',\n    method: 'POST',\n    requestId: uuidv4(),\n  };\n\n  return withLoadingIndicator({\n    whileLoading: initial,\n    source: backendSrv.fetch<AlertingQueryResponse>(request).pipe(\n      mapToPanelData(initial),\n      catchError((error) => of(mapErrorToPanelData(initial, error))),\n      cancelNetworkRequestsOnUnsubscribe(backendSrv, request.requestId),\n      share()\n    ),\n  });\n};\n\nconst initialState = (queries: AlertQuery[], state: LoadingState): Record<string, PanelData> => {\n  return queries.reduce((dataByQuery: Record<string, PanelData>, query) => {\n    dataByQuery[query.refId] = {\n      state,\n      series: [],\n      timeRange: getTimeRange(query, queries),\n    };\n\n    return dataByQuery;\n  }, {});\n};\n\nconst getTimeRange = (query: AlertQuery, queries: AlertQuery[]): TimeRange => {\n  if (isExpressionQuery(query.model)) {\n    const relative = getTimeRangeForExpression(query.model, queries);\n    return rangeUtil.relativeToTimeRange(relative);\n  }\n\n  if (!query.relativeTimeRange) {\n    console.warn(`Query with refId: ${query.refId} did not have any relative time range, using default.`);\n    return getDefaultTimeRange();\n  }\n\n  return rangeUtil.relativeToTimeRange(query.relativeTimeRange);\n};\n\nconst mapToPanelData = (\n  dataByQuery: Record<string, PanelData>\n): OperatorFunction<FetchResponse<AlertingQueryResponse>, Record<string, PanelData>> => {\n  return map((response) => {\n    const { data } = response;\n    const results: Record<string, PanelData> = {};\n\n    for (const [refId, result] of Object.entries(data.results)) {\n      results[refId] = {\n        timeRange: dataByQuery[refId].timeRange,\n        state: LoadingState.Done,\n        series: result.frames.map(dataFrameFromJSON),\n      };\n    }\n\n    return results;\n  });\n};\n\nconst mapErrorToPanelData = (lastResult: Record<string, PanelData>, error: Error): Record<string, PanelData> => {\n  const queryError = toDataQueryError(error);\n\n  return applyChange(lastResult, (refId, data) => {\n    return {\n      ...data,\n      state: LoadingState.Error,\n      error: queryError,\n    };\n  });\n};\n\nconst applyChange = (\n  initial: Record<string, PanelData>,\n  change: (refId: string, data: PanelData) => PanelData\n): Record<string, PanelData> => {\n  const nextResult: Record<string, PanelData> = {};\n\n  for (const [refId, data] of Object.entries(initial)) {\n    nextResult[refId] = change(refId, data);\n  }\n\n  return nextResult;\n};\n","import React, { PureComponent } from 'react';\nimport { css } from '@emotion/css';\nimport {\n  DataQuery,\n  getDefaultRelativeTimeRange,\n  GrafanaTheme2,\n  LoadingState,\n  PanelData,\n  RelativeTimeRange,\n} from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { Button, HorizontalGroup, Icon, stylesFactory, Tooltip } from '@grafana/ui';\nimport { config } from '@grafana/runtime';\nimport { QueryRows } from './QueryRows';\nimport {\n  dataSource as expressionDatasource,\n  ExpressionDatasourceUID,\n} from 'app/features/expressions/ExpressionDatasource';\nimport { getNextRefIdChar } from 'app/core/utils/query';\nimport { defaultCondition } from 'app/features/expressions/utils/expressionTypes';\nimport { ExpressionQueryType } from 'app/features/expressions/types';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\nimport { AlertingQueryRunner } from '../../state/AlertingQueryRunner';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { isExpressionQuery } from 'app/features/expressions/guards';\n\ninterface Props {\n  value?: AlertQuery[];\n  onChange: (queries: AlertQuery[]) => void;\n}\n\ninterface State {\n  panelDataByRefId: Record<string, PanelData>;\n}\nexport class QueryEditor extends PureComponent<Props, State> {\n  private runner: AlertingQueryRunner;\n  private queries: AlertQuery[];\n\n  constructor(props: Props) {\n    super(props);\n    this.state = { panelDataByRefId: {} };\n    this.runner = new AlertingQueryRunner();\n    this.queries = props.value ?? [];\n  }\n\n  componentDidMount() {\n    this.runner.get().subscribe((data) => {\n      this.setState({ panelDataByRefId: data });\n    });\n  }\n\n  componentWillUnmount() {\n    this.runner.destroy();\n  }\n\n  onRunQueries = () => {\n    const { queries } = this;\n    this.runner.run(queries);\n  };\n\n  onCancelQueries = () => {\n    this.runner.cancel();\n  };\n\n  onChangeQueries = (queries: AlertQuery[]) => {\n    this.queries = queries;\n    this.props.onChange(queries);\n  };\n\n  onDuplicateQuery = (query: AlertQuery) => {\n    const { queries } = this;\n    this.onChangeQueries(addQuery(queries, query));\n  };\n\n  onNewAlertingQuery = () => {\n    const { queries } = this;\n    const defaultDataSource = getDatasourceSrv().getInstanceSettings('default');\n\n    if (!defaultDataSource) {\n      return;\n    }\n\n    this.onChangeQueries(\n      addQuery(queries, {\n        datasourceUid: defaultDataSource.uid,\n        model: {\n          refId: '',\n          datasource: defaultDataSource.name,\n        },\n      })\n    );\n  };\n\n  onNewExpressionQuery = () => {\n    const { queries } = this;\n\n    this.onChangeQueries(\n      addQuery(queries, {\n        datasourceUid: ExpressionDatasourceUID,\n        model: expressionDatasource.newQuery({\n          type: ExpressionQueryType.classic,\n          conditions: [defaultCondition],\n        }),\n      })\n    );\n  };\n\n  renderAddQueryRow(styles: ReturnType<typeof getStyles>) {\n    return (\n      <HorizontalGroup spacing=\"md\" align=\"flex-start\">\n        <Button\n          type=\"button\"\n          icon=\"plus\"\n          onClick={this.onNewAlertingQuery}\n          variant=\"secondary\"\n          aria-label={selectors.components.QueryTab.addQuery}\n        >\n          Query\n        </Button>\n        {config.expressionsEnabled && (\n          <Tooltip content=\"Beta feature: queries could stop working in next version\" placement=\"right\">\n            <Button\n              type=\"button\"\n              icon=\"plus\"\n              onClick={this.onNewExpressionQuery}\n              variant=\"secondary\"\n              className={styles.expressionButton}\n            >\n              <span>Expression&nbsp;</span>\n              <Icon name=\"exclamation-triangle\" className=\"muted\" size=\"sm\" />\n            </Button>\n          </Tooltip>\n        )}\n      </HorizontalGroup>\n    );\n  }\n\n  isRunning() {\n    const data = Object.values(this.state.panelDataByRefId).find((d) => Boolean(d));\n    return data?.state === LoadingState.Loading;\n  }\n\n  renderRunQueryButton() {\n    const isRunning = this.isRunning();\n    const styles = getStyles(config.theme2);\n\n    if (isRunning) {\n      return (\n        <div className={styles.runWrapper}>\n          <Button icon=\"fa fa-spinner\" type=\"button\" variant=\"destructive\" onClick={this.onCancelQueries}>\n            Cancel\n          </Button>\n        </div>\n      );\n    }\n\n    return (\n      <div className={styles.runWrapper}>\n        <Button icon=\"sync\" type=\"button\" onClick={this.onRunQueries}>\n          Run queries\n        </Button>\n      </div>\n    );\n  }\n\n  render() {\n    const { value = [] } = this.props;\n    const { panelDataByRefId } = this.state;\n    const styles = getStyles(config.theme2);\n\n    return (\n      <div className={styles.container}>\n        <QueryRows\n          data={panelDataByRefId}\n          queries={value}\n          onQueriesChange={this.onChangeQueries}\n          onDuplicateQuery={this.onDuplicateQuery}\n          onRunQueries={this.onRunQueries}\n        />\n        {this.renderAddQueryRow(styles)}\n        {this.renderRunQueryButton()}\n      </div>\n    );\n  }\n}\n\nconst addQuery = (queries: AlertQuery[], queryToAdd: Pick<AlertQuery, 'model' | 'datasourceUid'>): AlertQuery[] => {\n  const refId = getNextRefIdChar(queries);\n\n  const query: AlertQuery = {\n    ...queryToAdd,\n    refId,\n    queryType: '',\n    model: {\n      ...queryToAdd.model,\n      hide: false,\n      refId,\n    },\n    relativeTimeRange: defaultTimeRange(queryToAdd.model),\n  };\n\n  return [...queries, query];\n};\n\nconst defaultTimeRange = (model: DataQuery): RelativeTimeRange | undefined => {\n  if (isExpressionQuery(model)) {\n    return;\n  }\n\n  return getDefaultRelativeTimeRange();\n};\n\nconst getStyles = stylesFactory((theme: GrafanaTheme2) => {\n  return {\n    container: css`\n      background-color: ${theme.colors.background.primary};\n      height: 100%;\n      max-width: ${theme.breakpoints.values.xxl}px;\n    `,\n    runWrapper: css`\n      margin-top: ${theme.spacing(1)};\n    `,\n    editorWrapper: css`\n      border: 1px solid ${theme.colors.border.medium};\n      border-radius: ${theme.shape.borderRadius()};\n    `,\n    expressionButton: css`\n      margin-right: ${theme.spacing(0.5)};\n    `,\n  };\n});\n","import React, { FC } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { Field, InputControl } from '@grafana/ui';\nimport { ExpressionEditor } from './ExpressionEditor';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { QueryEditor } from './QueryEditor';\n\nexport const QueryStep: FC = () => {\n  const {\n    control,\n    watch,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n  return (\n    <RuleEditorSection stepNo={2} title=\"Create a query to be alerted on\">\n      {type === RuleFormType.cloud && dataSourceName && (\n        <Field error={errors.expression?.message} invalid={!!errors.expression?.message}>\n          <InputControl\n            name=\"expression\"\n            render={({ field: { ref, ...field } }) => <ExpressionEditor {...field} dataSourceName={dataSourceName} />}\n            control={control}\n            rules={{\n              required: { value: true, message: 'A valid expression is required' },\n            }}\n          />\n        </Field>\n      )}\n      {type === RuleFormType.grafana && (\n        <Field\n          invalid={!!errors.queries}\n          error={(!!errors.queries && 'Must provide at least one valid query.') || undefined}\n        >\n          <InputControl\n            name=\"queries\"\n            render={({ field: { ref, ...field } }) => <QueryEditor {...field} />}\n            control={control}\n            rules={{\n              validate: (queries) => Array.isArray(queries) && !!queries.length,\n            }}\n          />\n        </Field>\n      )}\n    </RuleEditorSection>\n  );\n};\n","import {\n  dataFrameFromJSON,\n  DataFrameJSON,\n  getDefaultTimeRange,\n  LoadingState,\n  PanelData,\n  withLoadingIndicator,\n} from '@grafana/data';\nimport { getBackendSrv, toDataQueryError } from '@grafana/runtime';\nimport { Observable, of } from 'rxjs';\nimport { catchError, map, share } from 'rxjs/operators';\nimport {\n  CloudPreviewRuleRequest,\n  GrafanaPreviewRuleRequest,\n  isCloudPreviewRequest,\n  isGrafanaPreviewRequest,\n  PreviewRuleRequest,\n  PreviewRuleResponse,\n} from '../types/preview';\nimport { RuleFormType } from '../types/rule-form';\n\nexport function previewAlertRule(request: PreviewRuleRequest): Observable<PreviewRuleResponse> {\n  if (isCloudPreviewRequest(request)) {\n    return previewCloudAlertRule(request);\n  }\n\n  if (isGrafanaPreviewRequest(request)) {\n    return previewGrafanaAlertRule(request);\n  }\n\n  throw new Error('unsupported preview rule request');\n}\n\ntype GrafanaPreviewRuleResponse = {\n  instances: DataFrameJSON[];\n};\n\nfunction previewGrafanaAlertRule(request: GrafanaPreviewRuleRequest): Observable<PreviewRuleResponse> {\n  const type = RuleFormType.grafana;\n\n  return withLoadingIndicator({\n    whileLoading: createResponse(type),\n    source: getBackendSrv()\n      .fetch<GrafanaPreviewRuleResponse>({\n        method: 'POST',\n        url: `/api/v1/rule/test/grafana`,\n        data: request,\n      })\n      .pipe(\n        map(({ data }) => {\n          return createResponse(type, {\n            state: LoadingState.Done,\n            series: data.instances.map(dataFrameFromJSON),\n          });\n        }),\n        catchError((error: Error) => {\n          return of(\n            createResponse(type, {\n              state: LoadingState.Error,\n              error: toDataQueryError(error),\n            })\n          );\n        }),\n        share()\n      ),\n  });\n}\n\nfunction createResponse(ruleType: RuleFormType, data: Partial<PanelData> = {}): PreviewRuleResponse {\n  return {\n    ruleType,\n    data: {\n      state: LoadingState.Loading,\n      series: [],\n      timeRange: getDefaultTimeRange(),\n      ...data,\n    },\n  };\n}\n\nfunction previewCloudAlertRule(request: CloudPreviewRuleRequest): Observable<PreviewRuleResponse> {\n  throw new Error('preview for cloud alerting rules is not implemented');\n}\n","import { PanelData } from '@grafana/data';\nimport { AlertQuery } from 'app/types/unified-alerting-dto';\nimport { RuleFormType } from './rule-form';\n\nexport type PreviewRuleRequest = GrafanaPreviewRuleRequest | CloudPreviewRuleRequest;\n\nexport type GrafanaPreviewRuleRequest = {\n  grafana_condition: {\n    condition: string;\n    data: AlertQuery[];\n    now: string;\n  };\n};\n\nexport type CloudPreviewRuleRequest = {\n  dataSourceName: string;\n  expr: string;\n};\n\nexport type PreviewRuleResponse = {\n  ruleType: RuleFormType;\n  data: PanelData;\n};\n\nexport function isCloudPreviewRequest(request: PreviewRuleRequest): request is CloudPreviewRuleRequest {\n  return 'expr' in request;\n}\n\nexport function isGrafanaPreviewRequest(request: PreviewRuleRequest): request is GrafanaPreviewRuleRequest {\n  return 'grafana_condition' in request;\n}\n","import React from 'react';\nimport { css } from '@emotion/css';\nimport AutoSizer from 'react-virtualized-auto-sizer';\nimport { useStyles2 } from '@grafana/ui';\nimport { PanelRenderer } from '@grafana/runtime';\nimport { GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { PreviewRuleResponse } from '../../types/preview';\nimport { RuleFormType } from '../../types/rule-form';\n\ntype Props = {\n  preview: PreviewRuleResponse | undefined;\n};\n\nexport function PreviewRuleResult(props: Props): React.ReactElement | null {\n  const { preview } = props;\n  const styles = useStyles2(getStyles);\n\n  if (!preview) {\n    return null;\n  }\n\n  const { data, ruleType } = preview;\n\n  if (data.state === LoadingState.Loading) {\n    return (\n      <div className={styles.container}>\n        <span>Loading preview...</span>\n      </div>\n    );\n  }\n\n  if (data.state === LoadingState.Error) {\n    return <div className={styles.container}>{data.error ?? 'Failed to preview alert rule'}</div>;\n  }\n\n  return (\n    <div className={styles.container}>\n      <span>\n        Preview based on the result of running the query, for this moment.{' '}\n        {ruleType === RuleFormType.grafana ? 'Configuration for `no data` and `error handling` is not applied.' : null}\n      </span>\n      <div className={styles.table}>\n        <AutoSizer>\n          {({ width, height }) => (\n            <div style={{ width: `${width}px`, height: `${height}px` }}>\n              <PanelRenderer title=\"\" width={width} height={height} pluginId=\"table\" data={data} />\n            </div>\n          )}\n        </AutoSizer>\n      </div>\n    </div>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      margin: ${theme.spacing(2)} 0;\n    `,\n    table: css`\n      flex: 1 1 auto;\n      height: 135px;\n      margin-top: ${theme.spacing(2)};\n      border: 1px solid ${theme.colors.border.medium};\n      border-radius: ${theme.shape.borderRadius(1)};\n    `,\n  };\n}\n","import React, { useCallback, useState } from 'react';\nimport { css } from '@emotion/css';\nimport { useFormContext } from 'react-hook-form';\nimport { takeWhile } from 'rxjs/operators';\nimport { useMountedState } from 'react-use';\nimport { Button, HorizontalGroup, useStyles2 } from '@grafana/ui';\nimport { dateTimeFormatISO, GrafanaTheme2, LoadingState } from '@grafana/data';\nimport { RuleFormType } from '../../types/rule-form';\nimport { PreviewRuleRequest, PreviewRuleResponse } from '../../types/preview';\nimport { previewAlertRule } from '../../api/preview';\nimport { PreviewRuleResult } from './PreviewRuleResult';\n\nconst fields: string[] = ['type', 'dataSourceName', 'condition', 'queries', 'expression'];\n\nexport function PreviewRule(): React.ReactElement | null {\n  const styles = useStyles2(getStyles);\n  const [preview, onPreview] = usePreview();\n  const { getValues } = useFormContext();\n  const [type] = getValues(fields);\n\n  if (type === RuleFormType.cloud) {\n    return null;\n  }\n\n  return (\n    <div className={styles.container}>\n      <HorizontalGroup>\n        <Button type=\"button\" variant=\"primary\" onClick={onPreview}>\n          Preview alerts\n        </Button>\n      </HorizontalGroup>\n      <PreviewRuleResult preview={preview} />\n    </div>\n  );\n}\n\nfunction usePreview(): [PreviewRuleResponse | undefined, () => void] {\n  const [preview, setPreview] = useState<PreviewRuleResponse | undefined>();\n  const { getValues } = useFormContext();\n  const isMounted = useMountedState();\n\n  const onPreview = useCallback(() => {\n    const values = getValues(fields);\n    const request = createPreviewRequest(values);\n\n    previewAlertRule(request)\n      .pipe(takeWhile((response) => !isCompleted(response), true))\n      .subscribe((response) => {\n        if (!isMounted()) {\n          return;\n        }\n        setPreview(response);\n      });\n  }, [getValues, isMounted]);\n\n  return [preview, onPreview];\n}\n\nfunction createPreviewRequest(values: any[]): PreviewRuleRequest {\n  const [type, dataSourceName, condition, queries, expression] = values;\n\n  switch (type) {\n    case RuleFormType.cloud:\n      return {\n        dataSourceName,\n        expr: expression,\n      };\n\n    case RuleFormType.grafana:\n      return {\n        grafana_condition: {\n          condition,\n          data: queries,\n          now: dateTimeFormatISO(Date.now()),\n        },\n      };\n\n    default:\n      throw new Error(`Alert type ${type} not supported by preview.`);\n  }\n}\n\nfunction isCompleted(response: PreviewRuleResponse): boolean {\n  switch (response.data.state) {\n    case LoadingState.Done:\n    case LoadingState.Error:\n      return true;\n    default:\n      return false;\n  }\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    container: css`\n      margin-top: ${theme.spacing(2)};\n    `,\n  };\n}\n","import React, { FC } from 'react';\nimport { css } from '@emotion/css';\nimport { GrafanaTheme } from '@grafana/data';\nimport { Field, Input, InputControl, Select, useStyles } from '@grafana/ui';\nimport { useFormContext } from 'react-hook-form';\nimport { RuleFormValues } from '../../types/rule-form';\nimport { timeOptions } from '../../utils/time';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { PreviewRule } from './PreviewRule';\n\nexport const CloudConditionsStep: FC = () => {\n  const styles = useStyles(getStyles);\n  const {\n    register,\n    control,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  return (\n    <RuleEditorSection stepNo={3} title=\"Define alert conditions\">\n      <Field label=\"For\" description=\"Expression has to be true for this long for the alert to be fired.\">\n        <div className={styles.flexRow}>\n          <Field invalid={!!errors.forTime?.message} error={errors.forTime?.message} className={styles.inlineField}>\n            <Input\n              {...register('forTime', { pattern: { value: /^\\d+$/, message: 'Must be a positive integer.' } })}\n              width={8}\n            />\n          </Field>\n          <InputControl\n            name=\"forTimeUnit\"\n            render={({ field: { onChange, ref, ...field } }) => (\n              <Select\n                {...field}\n                options={timeOptions}\n                onChange={(value) => onChange(value?.value)}\n                width={15}\n                className={styles.timeUnit}\n              />\n            )}\n            control={control}\n          />\n        </div>\n      </Field>\n      <PreviewRule />\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  inlineField: css`\n    margin-bottom: 0;\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: flex-start;\n  `,\n  timeUnit: css`\n    margin-left: ${theme.spacing.xs};\n  `,\n});\n","import { SelectableValue } from '@grafana/data';\nimport { Field, InputControl, Select } from '@grafana/ui';\nimport { ExpressionDatasourceID } from 'app/features/expressions/ExpressionDatasource';\nimport React, { FC, useEffect, useMemo } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { RuleFormValues } from '../../types/rule-form';\n\nexport const ConditionField: FC = () => {\n  const {\n    watch,\n    setValue,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  const queries = watch('queries');\n  const condition = watch('condition');\n\n  const options = useMemo(\n    (): SelectableValue[] =>\n      queries\n        .filter((q) => !!q.refId)\n        .map((q) => ({\n          value: q.refId,\n          label: q.refId,\n        })),\n    [queries]\n  );\n\n  // reset condition if option no longer exists or if it is unset, but there are options available\n  useEffect(() => {\n    const expressions = queries.filter((query) => query.model.datasource === ExpressionDatasourceID);\n    if (condition && !options.find(({ value }) => value === condition)) {\n      setValue('condition', expressions.length ? expressions[expressions.length - 1].refId : null);\n    } else if (!condition && expressions.length) {\n      setValue('condition', expressions[expressions.length - 1].refId);\n    }\n  }, [condition, options, queries, setValue]);\n\n  return (\n    <Field\n      label=\"Condition\"\n      description=\"The query or expression that will be alerted on\"\n      error={errors.condition?.message}\n      invalid={!!errors.condition?.message}\n    >\n      <InputControl\n        name=\"condition\"\n        render={({ field: { onChange, ref, ...field } }) => (\n          <Select\n            {...field}\n            width={42}\n            options={options}\n            onChange={(v: SelectableValue) => onChange(v?.value ?? null)}\n            noOptionsMessage=\"No queries defined\"\n          />\n        )}\n        rules={{\n          required: {\n            value: true,\n            message: 'Please select the condition to alert on',\n          },\n        }}\n      />\n    </Field>\n  );\n};\n","import { SelectableValue } from '@grafana/data';\nimport { Select } from '@grafana/ui';\nimport { SelectBaseProps } from '@grafana/ui/src/components/Select/types';\nimport { GrafanaAlertStateDecision } from 'app/types/unified-alerting-dto';\nimport React, { FC, useMemo } from 'react';\n\ntype Props = Omit<SelectBaseProps<GrafanaAlertStateDecision>, 'options'> & {\n  includeNoData: boolean;\n};\n\nconst options: SelectableValue[] = [\n  { value: GrafanaAlertStateDecision.Alerting, label: 'Alerting' },\n  { value: GrafanaAlertStateDecision.NoData, label: 'No Data' },\n  { value: GrafanaAlertStateDecision.OK, label: 'OK' },\n];\n\nexport const GrafanaAlertStatePicker: FC<Props> = ({ includeNoData, ...props }) => {\n  const opts = useMemo(() => {\n    if (includeNoData) {\n      return options;\n    }\n    return options.filter((opt) => opt.value !== GrafanaAlertStateDecision.NoData);\n  }, [includeNoData]);\n  return <Select options={opts} {...props} />;\n};\n","import { durationToMilliseconds, parseDuration } from '@grafana/data';\nimport { Alert } from '@grafana/ui';\nimport { isEmpty } from 'lodash';\nimport React, { FC } from 'react';\nimport { useFormContext } from 'react-hook-form';\nimport { RuleFormValues } from '../../types/rule-form';\n\n// a warning that will be shown if a problematic yet technically valid combination of \"evaluate every\" and \"evaluate for\" is enetered\nexport const GrafanaConditionEvalWarning: FC = () => {\n  const { watch } = useFormContext<RuleFormValues>();\n  const evaluateFor = watch('evaluateFor');\n  const evaluateEvery = watch('evaluateEvery');\n  if (evaluateFor === '0') {\n    return null;\n  }\n  const durationFor = parseDuration(evaluateFor);\n  const durationEvery = parseDuration(evaluateEvery);\n  if (isEmpty(durationFor) || isEmpty(durationEvery)) {\n    return null;\n  }\n  const millisFor = durationToMilliseconds(durationFor);\n  const millisEvery = durationToMilliseconds(durationEvery);\n  if (millisFor && millisEvery && millisFor <= millisEvery) {\n    return (\n      <Alert severity=\"warning\" title=\"\">\n        Setting a &quot;for&quot; duration that is less than or equal to the evaluation interval will result in the\n        evaluation interval being used to calculate when an alert that has stopped receiving data will be closed.\n      </Alert>\n    );\n  }\n  return null;\n};\n","import React, { FC, useState } from 'react';\nimport { css } from '@emotion/css';\nimport { GrafanaTheme, parseDuration, durationToMilliseconds } from '@grafana/data';\nimport { Field, InlineLabel, Input, InputControl, Switch, useStyles } from '@grafana/ui';\nimport { useFormContext, RegisterOptions } from 'react-hook-form';\nimport { RuleFormValues } from '../../types/rule-form';\nimport { positiveDurationValidationPattern, durationValidationPattern } from '../../utils/time';\nimport { ConditionField } from './ConditionField';\nimport { GrafanaAlertStatePicker } from './GrafanaAlertStatePicker';\nimport { RuleEditorSection } from './RuleEditorSection';\nimport { PreviewRule } from './PreviewRule';\nimport { GrafanaConditionEvalWarning } from './GrafanaConditionEvalWarning';\n\nconst MIN_TIME_RANGE_STEP_S = 10; // 10 seconds\n\nconst forValidationOptions: RegisterOptions = {\n  required: {\n    value: true,\n    message: 'Required.',\n  },\n  pattern: durationValidationPattern,\n};\n\nconst evaluateEveryValidationOptions: RegisterOptions = {\n  required: {\n    value: true,\n    message: 'Required.',\n  },\n  pattern: positiveDurationValidationPattern,\n  validate: (value: string) => {\n    const duration = parseDuration(value);\n    if (Object.keys(duration).length) {\n      const diff = durationToMilliseconds(duration);\n      if (diff < MIN_TIME_RANGE_STEP_S * 1000) {\n        return `Cannot be less than ${MIN_TIME_RANGE_STEP_S} seconds.`;\n      }\n      if (diff % (MIN_TIME_RANGE_STEP_S * 1000) !== 0) {\n        return `Must be a multiple of ${MIN_TIME_RANGE_STEP_S} seconds.`;\n      }\n    }\n    return true;\n  },\n};\n\nexport const GrafanaConditionsStep: FC = () => {\n  const styles = useStyles(getStyles);\n  const [showErrorHandling, setShowErrorHandling] = useState(false);\n  const {\n    register,\n    formState: { errors },\n  } = useFormContext<RuleFormValues>();\n\n  return (\n    <RuleEditorSection stepNo={3} title=\"Define alert conditions\">\n      <ConditionField />\n      <Field label=\"Evaluate\">\n        <div className={styles.flexRow}>\n          <InlineLabel width={16} tooltip=\"How often the alert will be evaluated to see if it fires\">\n            Evaluate every\n          </InlineLabel>\n          <Field\n            className={styles.inlineField}\n            error={errors.evaluateEvery?.message}\n            invalid={!!errors.evaluateEvery?.message}\n            validationMessageHorizontalOverflow={true}\n          >\n            <Input width={8} {...register('evaluateEvery', evaluateEveryValidationOptions)} />\n          </Field>\n          <InlineLabel\n            width={7}\n            tooltip='Once condition is breached, alert will go into pending state. If it is pending for longer than the \"for\" value, it will become a firing alert.'\n          >\n            for\n          </InlineLabel>\n          <Field\n            className={styles.inlineField}\n            error={errors.evaluateFor?.message}\n            invalid={!!errors.evaluateFor?.message}\n            validationMessageHorizontalOverflow={true}\n          >\n            <Input width={8} {...register('evaluateFor', forValidationOptions)} />\n          </Field>\n        </div>\n      </Field>\n      <GrafanaConditionEvalWarning />\n      <Field label=\"Configure no data and error handling\" horizontal={true} className={styles.switchField}>\n        <Switch value={showErrorHandling} onChange={() => setShowErrorHandling(!showErrorHandling)} />\n      </Field>\n      {showErrorHandling && (\n        <>\n          <Field label=\"Alert state if no data or all values are null\">\n            <InputControl\n              render={({ field: { onChange, ref, ...field } }) => (\n                <GrafanaAlertStatePicker\n                  {...field}\n                  width={42}\n                  includeNoData={true}\n                  onChange={(value) => onChange(value?.value)}\n                />\n              )}\n              name=\"noDataState\"\n            />\n          </Field>\n          <Field label=\"Alert state if execution error or timeout\">\n            <InputControl\n              render={({ field: { onChange, ref, ...field } }) => (\n                <GrafanaAlertStatePicker\n                  {...field}\n                  width={42}\n                  includeNoData={false}\n                  onChange={(value) => onChange(value?.value)}\n                />\n              )}\n              name=\"execErrState\"\n            />\n          </Field>\n        </>\n      )}\n      <PreviewRule />\n    </RuleEditorSection>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  inlineField: css`\n    margin-bottom: 0;\n  `,\n  flexRow: css`\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: flex-start;\n  `,\n  switchField: css`\n    display: inline-flex;\n    flex-direction: row-reverse;\n    margin-top: ${theme.spacing.md};\n    & > div:first-child {\n      margin-left: ${theme.spacing.sm};\n    }\n  `,\n});\n","import React, { FC, useMemo } from 'react';\nimport { GrafanaTheme2, AppEvents } from '@grafana/data';\nimport { PageToolbar, Button, useStyles2, CustomScrollbar, Spinner } from '@grafana/ui';\nimport { css } from '@emotion/css';\n\nimport { AlertTypeStep } from './AlertTypeStep';\nimport { DetailsStep } from './DetailsStep';\nimport { QueryStep } from './QueryStep';\nimport { useForm, FormProvider } from 'react-hook-form';\n\nimport { RuleFormType, RuleFormValues } from '../../types/rule-form';\nimport { useUnifiedAlertingSelector } from '../../hooks/useUnifiedAlertingSelector';\nimport { initialAsyncRequestState } from '../../utils/redux';\nimport { saveRuleFormAction } from '../../state/actions';\nimport { RuleWithLocation } from 'app/types/unified-alerting';\nimport { useDispatch } from 'react-redux';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { rulerRuleToFormValues, getDefaultFormValues, getDefaultQueries } from '../../utils/rule-form';\nimport { Link } from 'react-router-dom';\nimport { useQueryParams } from 'app/core/hooks/useQueryParams';\n\nimport { appEvents } from 'app/core/core';\nimport { CloudConditionsStep } from './CloudConditionsStep';\nimport { GrafanaConditionsStep } from './GrafanaConditionsStep';\n\ntype Props = {\n  existing?: RuleWithLocation;\n};\n\nexport const AlertRuleForm: FC<Props> = ({ existing }) => {\n  const styles = useStyles2(getStyles);\n  const dispatch = useDispatch();\n  const [queryParams] = useQueryParams();\n\n  const returnTo: string = (queryParams['returnTo'] as string | undefined) ?? '/alerting/list';\n\n  const defaultValues: RuleFormValues = useMemo(() => {\n    if (existing) {\n      return rulerRuleToFormValues(existing);\n    }\n    return {\n      ...getDefaultFormValues(),\n      queries: getDefaultQueries(),\n      ...(queryParams['defaults'] ? JSON.parse(queryParams['defaults'] as string) : {}),\n    };\n  }, [existing, queryParams]);\n\n  const formAPI = useForm<RuleFormValues>({\n    mode: 'onSubmit',\n    defaultValues,\n    shouldFocusError: true,\n  });\n\n  const { handleSubmit, watch } = formAPI;\n\n  const type = watch('type');\n  const dataSourceName = watch('dataSourceName');\n\n  const showStep2 = Boolean(type && (type === RuleFormType.grafana || !!dataSourceName));\n\n  const submitState = useUnifiedAlertingSelector((state) => state.ruleForm.saveRule) || initialAsyncRequestState;\n  useCleanup((state) => state.unifiedAlerting.ruleForm.saveRule);\n\n  const submit = (values: RuleFormValues, exitOnSave: boolean) => {\n    dispatch(\n      saveRuleFormAction({\n        values: {\n          ...defaultValues,\n          ...values,\n          annotations:\n            values.annotations\n              ?.map(({ key, value }) => ({ key: key.trim(), value: value.trim() }))\n              .filter(({ key, value }) => !!key && !!value) ?? [],\n          labels:\n            values.labels\n              ?.map(({ key, value }) => ({ key: key.trim(), value: value.trim() }))\n              .filter(({ key }) => !!key) ?? [],\n        },\n        existing,\n        redirectOnSave: exitOnSave ? returnTo : undefined,\n      })\n    );\n  };\n\n  const onInvalid = () => {\n    appEvents.emit(AppEvents.alertError, ['There are errors in the form. Please correct them and try again!']);\n  };\n\n  return (\n    <FormProvider {...formAPI}>\n      <form onSubmit={(e) => e.preventDefault()} className={styles.form}>\n        <PageToolbar title=\"Create alert rule\" pageIcon=\"bell\">\n          <Link to={returnTo}>\n            <Button variant=\"secondary\" disabled={submitState.loading} type=\"button\" fill=\"outline\">\n              Cancel\n            </Button>\n          </Link>\n          <Button\n            variant=\"secondary\"\n            type=\"button\"\n            onClick={handleSubmit((values) => submit(values, false), onInvalid)}\n            disabled={submitState.loading}\n          >\n            {submitState.loading && <Spinner className={styles.buttonSpinner} inline={true} />}\n            Save\n          </Button>\n          <Button\n            variant=\"primary\"\n            type=\"button\"\n            onClick={handleSubmit((values) => submit(values, true), onInvalid)}\n            disabled={submitState.loading}\n          >\n            {submitState.loading && <Spinner className={styles.buttonSpinner} inline={true} />}\n            Save and exit\n          </Button>\n        </PageToolbar>\n        <div className={styles.contentOuter}>\n          <CustomScrollbar autoHeightMin=\"100%\" hideHorizontalTrack={true}>\n            <div className={styles.contentInner}>\n              <AlertTypeStep editingExistingRule={!!existing} />\n              {showStep2 && (\n                <>\n                  <QueryStep />\n                  {type === RuleFormType.cloud ? <CloudConditionsStep /> : <GrafanaConditionsStep />}\n                  <DetailsStep />\n                </>\n              )}\n            </div>\n          </CustomScrollbar>\n        </div>\n      </form>\n    </FormProvider>\n  );\n};\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    buttonSpinner: css`\n      margin-right: ${theme.spacing(1)};\n    `,\n    form: css`\n      width: 100%;\n      height: 100%;\n      display: flex;\n      flex-direction: column;\n    `,\n    contentInner: css`\n      flex: 1;\n      padding: ${theme.spacing(2)};\n    `,\n    contentOuter: css`\n      background: ${theme.colors.background.primary};\n      border: 1px solid ${theme.colors.border.weak};\n      border-radius: ${theme.shape.borderRadius()};\n      margin: ${theme.spacing(0, 2, 2)};\n      overflow: hidden;\n      flex: 1;\n    `,\n    flexRow: css`\n      display: flex;\n      flex-direction: row;\n      justify-content: flex-start;\n    `,\n  };\n};\n","import { css } from '@emotion/css';\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { Alert, LinkButton, LoadingPlaceholder, useStyles2, withErrorBoundary } from '@grafana/ui';\nimport Page from 'app/core/components/Page/Page';\nimport { contextSrv } from 'app/core/services/context_srv';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { GrafanaRouteComponentProps } from 'app/core/navigation/types';\nimport { RuleIdentifier } from 'app/types/unified-alerting';\nimport React, { FC, useEffect } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { AlertRuleForm } from './components/rule-editor/AlertRuleForm';\nimport { useIsRuleEditable } from './hooks/useIsRuleEditable';\nimport { useUnifiedAlertingSelector } from './hooks/useUnifiedAlertingSelector';\nimport { fetchExistingRuleAction } from './state/actions';\nimport { parseRuleIdentifier } from './utils/rules';\n\ninterface ExistingRuleEditorProps {\n  identifier: RuleIdentifier;\n}\n\nconst ExistingRuleEditor: FC<ExistingRuleEditorProps> = ({ identifier }) => {\n  useCleanup((state) => state.unifiedAlerting.ruleForm.existingRule);\n  const { loading, result, error, dispatched } = useUnifiedAlertingSelector((state) => state.ruleForm.existingRule);\n  const dispatch = useDispatch();\n  const { isEditable } = useIsRuleEditable(result?.rule);\n\n  useEffect(() => {\n    if (!dispatched) {\n      dispatch(fetchExistingRuleAction(identifier));\n    }\n  }, [dispatched, dispatch, identifier]);\n\n  if (loading || isEditable === undefined) {\n    return (\n      <Page.Contents>\n        <LoadingPlaceholder text=\"Loading rule...\" />\n      </Page.Contents>\n    );\n  }\n  if (error) {\n    return (\n      <Page.Contents>\n        <Alert severity=\"error\" title=\"Failed to load rule\">\n          {error.message}\n        </Alert>\n      </Page.Contents>\n    );\n  }\n  if (!result) {\n    return <AlertWarning title=\"Rule not found\">Sorry! This rule does not exist.</AlertWarning>;\n  }\n  if (isEditable === false) {\n    return <AlertWarning title=\"Cannot edit rule\">Sorry! You do not have permission to edit this rule.</AlertWarning>;\n  }\n  return <AlertRuleForm existing={result} />;\n};\n\ntype RuleEditorProps = GrafanaRouteComponentProps<{ id?: string }>;\n\nconst RuleEditor: FC<RuleEditorProps> = ({ match }) => {\n  const id = match.params.id;\n  if (id) {\n    const identifier = parseRuleIdentifier(decodeURIComponent(id));\n    return <ExistingRuleEditor key={id} identifier={identifier} />;\n  }\n  if (!(contextSrv.hasEditPermissionInFolders || contextSrv.isEditor)) {\n    return <AlertWarning title=\"Cannot create rules\">Sorry! You are not allowed to create rules.</AlertWarning>;\n  }\n  return <AlertRuleForm />;\n};\n\nconst AlertWarning: FC<{ title: string }> = ({ title, children }) => (\n  <Alert className={useStyles2(warningStyles).warning} severity=\"warning\" title={title}>\n    <p>{children}</p>\n    <LinkButton href=\"alerting/list\">To rule list</LinkButton>\n  </Alert>\n);\n\nconst warningStyles = (theme: GrafanaTheme2) => ({\n  warning: css`\n    margin: ${theme.spacing(4)};\n  `,\n});\n\nexport default withErrorBoundary(RuleEditor, { style: 'page' });\n","import { UrlQueryMap } from '@grafana/data';\nimport { locationSearchToObject, locationService } from '@grafana/runtime';\nimport { useCallback, useMemo } from 'react';\nimport { useLocation } from 'react-router-dom';\n\nexport function useQueryParams(): [UrlQueryMap, (values: UrlQueryMap, replace?: boolean) => void] {\n  const { search } = useLocation();\n  const queryParams = useMemo(() => locationSearchToObject(search || ''), [search]);\n  const update = useCallback(\n    (values: UrlQueryMap, replace?: boolean) => setImmediate(() => locationService.partial(values, replace)),\n    []\n  );\n  return [queryParams, update];\n}\n","import { FolderDTO } from 'app/types';\nimport { useDispatch } from 'react-redux';\nimport { useUnifiedAlertingSelector } from './useUnifiedAlertingSelector';\nimport { useEffect } from 'react';\nimport { fetchFolderIfNotFetchedAction } from '../state/actions';\nimport { initialAsyncRequestState } from '../utils/redux';\n\ninterface ReturnBag {\n  folder?: FolderDTO;\n  loading: boolean;\n}\n\nexport function useFolder(uid?: string): ReturnBag {\n  const dispatch = useDispatch();\n  const folderRequests = useUnifiedAlertingSelector((state) => state.folders);\n  useEffect(() => {\n    if (uid) {\n      dispatch(fetchFolderIfNotFetchedAction(uid));\n    }\n  }, [dispatch, uid]);\n\n  if (uid) {\n    const request = folderRequests[uid] || initialAsyncRequestState;\n    return {\n      folder: request.result,\n      loading: request.loading,\n    };\n  }\n  return {\n    loading: false,\n  };\n}\n","import { contextSrv } from 'app/core/services/context_srv';\nimport { isGrafanaRulerRule } from '../utils/rules';\nimport { RulerRuleDTO } from 'app/types/unified-alerting-dto';\nimport { useFolder } from './useFolder';\n\ninterface ResultBag {\n  isEditable?: boolean;\n  loading: boolean;\n}\n\nexport function useIsRuleEditable(rule?: RulerRuleDTO): ResultBag {\n  const folderUID = rule && isGrafanaRulerRule(rule) ? rule.grafana_alert.namespace_uid : undefined;\n\n  const { folder, loading } = useFolder(folderUID);\n\n  if (!rule) {\n    return { isEditable: false, loading: false };\n  }\n\n  // grafana rules can be edited if user can edit the folder they're in\n  if (isGrafanaRulerRule(rule)) {\n    if (!folderUID) {\n      throw new Error(\n        `Rule ${rule.grafana_alert.title} does not have a folder uid, cannot determine if it is editable.`\n      );\n    }\n    return {\n      isEditable: folder?.canSave,\n      loading,\n    };\n  }\n\n  // prom rules are only editable by users with Editor role\n  return {\n    isEditable: contextSrv.isEditor,\n    loading: false,\n  };\n}\n","import { useEffect, useRef } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { cleanUpAction, StateSelector } from '../actions/cleanUp';\n\nexport function useCleanup<T>(stateSelector: StateSelector<T>) {\n  const dispatch = useDispatch();\n  //bit of a hack to unburden user from having to wrap stateSelcetor in a useCallback. Otherwise cleanup would happen on every render\n  const selectorRef = useRef(stateSelector);\n  selectorRef.current = stateSelector;\n  useEffect(() => {\n    return () => {\n      dispatch(cleanUpAction({ stateSelector: selectorRef.current }));\n    };\n  }, [dispatch]);\n}\n","var scope = (typeof global !== \"undefined\" && global) ||\n            (typeof self !== \"undefined\" && self) ||\n            window;\nvar apply = Function.prototype.apply;\n\n// DOM APIs, for completeness\n\nexports.setTimeout = function() {\n  return new Timeout(apply.call(setTimeout, scope, arguments), clearTimeout);\n};\nexports.setInterval = function() {\n  return new Timeout(apply.call(setInterval, scope, arguments), clearInterval);\n};\nexports.clearTimeout =\nexports.clearInterval = function(timeout) {\n  if (timeout) {\n    timeout.close();\n  }\n};\n\nfunction Timeout(id, clearFn) {\n  this._id = id;\n  this._clearFn = clearFn;\n}\nTimeout.prototype.unref = Timeout.prototype.ref = function() {};\nTimeout.prototype.close = function() {\n  this._clearFn.call(scope, this._id);\n};\n\n// Does not start the time, just sets up the members needed.\nexports.enroll = function(item, msecs) {\n  clearTimeout(item._idleTimeoutId);\n  item._idleTimeout = msecs;\n};\n\nexports.unenroll = function(item) {\n  clearTimeout(item._idleTimeoutId);\n  item._idleTimeout = -1;\n};\n\nexports._unrefActive = exports.active = function(item) {\n  clearTimeout(item._idleTimeoutId);\n\n  var msecs = item._idleTimeout;\n  if (msecs >= 0) {\n    item._idleTimeoutId = setTimeout(function onTimeout() {\n      if (item._onTimeout)\n        item._onTimeout();\n    }, msecs);\n  }\n};\n\n// setimmediate attaches itself to the global object\nrequire(\"setimmediate\");\n// On some exotic environments, it's not clear which object `setimmediate` was\n// able to install onto.  Search each possibility in the same order as the\n// `setimmediate` library.\nexports.setImmediate = (typeof self !== \"undefined\" && self.setImmediate) ||\n                       (typeof global !== \"undefined\" && global.setImmediate) ||\n                       (this && this.setImmediate);\nexports.clearImmediate = (typeof self !== \"undefined\" && self.clearImmediate) ||\n                         (typeof global !== \"undefined\" && global.clearImmediate) ||\n                         (this && this.clearImmediate);\n","(function (global, undefined) {\n    \"use strict\";\n\n    if (global.setImmediate) {\n        return;\n    }\n\n    var nextHandle = 1; // Spec says greater than zero\n    var tasksByHandle = {};\n    var currentlyRunningATask = false;\n    var doc = global.document;\n    var registerImmediate;\n\n    function setImmediate(callback) {\n      // Callback can either be a function or a string\n      if (typeof callback !== \"function\") {\n        callback = new Function(\"\" + callback);\n      }\n      // Copy function arguments\n      var args = new Array(arguments.length - 1);\n      for (var i = 0; i < args.length; i++) {\n          args[i] = arguments[i + 1];\n      }\n      // Store and register the task\n      var task = { callback: callback, args: args };\n      tasksByHandle[nextHandle] = task;\n      registerImmediate(nextHandle);\n      return nextHandle++;\n    }\n\n    function clearImmediate(handle) {\n        delete tasksByHandle[handle];\n    }\n\n    function run(task) {\n        var callback = task.callback;\n        var args = task.args;\n        switch (args.length) {\n        case 0:\n            callback();\n            break;\n        case 1:\n            callback(args[0]);\n            break;\n        case 2:\n            callback(args[0], args[1]);\n            break;\n        case 3:\n            callback(args[0], args[1], args[2]);\n            break;\n        default:\n            callback.apply(undefined, args);\n            break;\n        }\n    }\n\n    function runIfPresent(handle) {\n        // From the spec: \"Wait until any invocations of this algorithm started before this one have completed.\"\n        // So if we're currently running a task, we'll need to delay this invocation.\n        if (currentlyRunningATask) {\n            // Delay by doing a setTimeout. setImmediate was tried instead, but in Firefox 7 it generated a\n            // \"too much recursion\" error.\n            setTimeout(runIfPresent, 0, handle);\n        } else {\n            var task = tasksByHandle[handle];\n            if (task) {\n                currentlyRunningATask = true;\n                try {\n                    run(task);\n                } finally {\n                    clearImmediate(handle);\n                    currentlyRunningATask = false;\n                }\n            }\n        }\n    }\n\n    function installNextTickImplementation() {\n        registerImmediate = function(handle) {\n            process.nextTick(function () { runIfPresent(handle); });\n        };\n    }\n\n    function canUsePostMessage() {\n        // The test against `importScripts` prevents this implementation from being installed inside a web worker,\n        // where `global.postMessage` means something completely different and can't be used for this purpose.\n        if (global.postMessage && !global.importScripts) {\n            var postMessageIsAsynchronous = true;\n            var oldOnMessage = global.onmessage;\n            global.onmessage = function() {\n                postMessageIsAsynchronous = false;\n            };\n            global.postMessage(\"\", \"*\");\n            global.onmessage = oldOnMessage;\n            return postMessageIsAsynchronous;\n        }\n    }\n\n    function installPostMessageImplementation() {\n        // Installs an event handler on `global` for the `message` event: see\n        // * https://developer.mozilla.org/en/DOM/window.postMessage\n        // * http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html#crossDocumentMessages\n\n        var messagePrefix = \"setImmediate$\" + Math.random() + \"$\";\n        var onGlobalMessage = function(event) {\n            if (event.source === global &&\n                typeof event.data === \"string\" &&\n                event.data.indexOf(messagePrefix) === 0) {\n                runIfPresent(+event.data.slice(messagePrefix.length));\n            }\n        };\n\n        if (global.addEventListener) {\n            global.addEventListener(\"message\", onGlobalMessage, false);\n        } else {\n            global.attachEvent(\"onmessage\", onGlobalMessage);\n        }\n\n        registerImmediate = function(handle) {\n            global.postMessage(messagePrefix + handle, \"*\");\n        };\n    }\n\n    function installMessageChannelImplementation() {\n        var channel = new MessageChannel();\n        channel.port1.onmessage = function(event) {\n            var handle = event.data;\n            runIfPresent(handle);\n        };\n\n        registerImmediate = function(handle) {\n            channel.port2.postMessage(handle);\n        };\n    }\n\n    function installReadyStateChangeImplementation() {\n        var html = doc.documentElement;\n        registerImmediate = function(handle) {\n            // Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted\n            // into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.\n            var script = doc.createElement(\"script\");\n            script.onreadystatechange = function () {\n                runIfPresent(handle);\n                script.onreadystatechange = null;\n                html.removeChild(script);\n                script = null;\n            };\n            html.appendChild(script);\n        };\n    }\n\n    function installSetTimeoutImplementation() {\n        registerImmediate = function(handle) {\n            setTimeout(runIfPresent, 0, handle);\n        };\n    }\n\n    // If supported, we should attach to the prototype of global, since that is where setTimeout et al. live.\n    var attachTo = Object.getPrototypeOf && Object.getPrototypeOf(global);\n    attachTo = attachTo && attachTo.setTimeout ? attachTo : global;\n\n    // Don't get fooled by e.g. browserify environments.\n    if ({}.toString.call(global.process) === \"[object process]\") {\n        // For Node.js before 0.9\n        installNextTickImplementation();\n\n    } else if (canUsePostMessage()) {\n        // For non-IE10 modern browsers\n        installPostMessageImplementation();\n\n    } else if (global.MessageChannel) {\n        // For web workers, where supported\n        installMessageChannelImplementation();\n\n    } else if (doc && \"onreadystatechange\" in doc.createElement(\"script\")) {\n        // For IE 68\n        installReadyStateChangeImplementation();\n\n    } else {\n        // For older browsers\n        installSetTimeoutImplementation();\n    }\n\n    attachTo.setImmediate = setImmediate;\n    attachTo.clearImmediate = clearImmediate;\n}(typeof self === \"undefined\" ? typeof global === \"undefined\" ? this : global : self));\n"],"sourceRoot":""}